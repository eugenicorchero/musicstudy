<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Music Study Protocol - Temporitzador i Metr√≤nom Focus</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
    <style>
        /* Professional Color Scheme */
        :root {
            --primary-bg: #1a1a2e;
            --secondary-bg: #16213e;
            --accent-cyan: #00ffff;
            --accent-green: #00ff9f;
            --accent-blue: #4ea5d9;
            --accent-purple: #9d4edd;
            --accent-pink: #f72585;
            --accent-orange: #f77f00;
            --text-white: #ffffff;
            --text-gray: #a8a8a8;
            --text-cyan: #00ffff;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        /* Dynamic background colors for phases */
        .bg-phase-green { background: linear-gradient(135deg, #0f4c3a 0%, #1a5f4a 100%); }
        .bg-phase-cyan { background: linear-gradient(135deg, #0a3a4a 0%, #1a4a5a 100%); }
        .bg-phase-blue { background: linear-gradient(135deg, #1a2d5a 0%, #2a3d6a 100%); }
        .bg-phase-purple { background: linear-gradient(135deg, #3a1a5a 0%, #4a2a6a 100%); }
        .bg-phase-pink { background: linear-gradient(135deg, #5a1a3a 0%, #6a2a4a 100%); }
        .bg-phase-orange { background: linear-gradient(135deg, #5a3a1a 0%, #6a4a2a 100%); }

        /* Base Styles */
        * {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            background: var(--primary-bg);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            min-height: 100dvh; /* Dynamic viewport height for mobile */
            color: var(--text-white);
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: background 0.8s ease-in-out;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar { 
            width: 6px; 
            height: 6px;
        }
        ::-webkit-scrollbar-track { 
            background: var(--secondary-bg); 
        }
        ::-webkit-scrollbar-thumb { 
            background: var(--accent-primary); 
            border-radius: 3px; 
        }
        ::-webkit-scrollbar-thumb:hover { 
            background: var(--accent-secondary); 
        }

        /* Glass morphism effect */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
        }

        /* Progress Ring Animation */
        .progress-ring__circle {
            transition: stroke-dashoffset 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            filter: drop-shadow(0 0 8px currentColor);
        }

        /* Enhanced Button Styles */
        .btn-primary {
            background: var(--gradient-accent);
            color: var(--primary-bg);
            border: none;
            border-radius: 16px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-glow);
            position: relative;
            overflow: hidden;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 255, 255, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
            box-shadow: var(--shadow-glow);
        }

        .btn-secondary {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            border: 1px solid var(--border-accent);
            border-radius: 12px;
            color: var(--text-primary);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-secondary:hover {
            background: var(--border-accent);
            transform: translateY(-1px);
        }

        /* Enhanced Range Slider */
        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            cursor: pointer;
            height: 8px;
            border-radius: 4px;
            background: var(--secondary-bg);
            outline: none;
            position: relative;
        }

        input[type=range]::-webkit-slider-track {
            background: var(--secondary-bg);
            height: 8px;
            border-radius: 4px;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--gradient-accent);
            cursor: pointer;
            box-shadow: 0 0 0 4px var(--glass-bg), 0 0 12px rgba(0, 255, 255, 0.6);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        input[type=range]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 0 0 6px var(--glass-bg), 0 0 16px rgba(0, 255, 255, 0.8);
        }

        input[type=range]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--gradient-accent);
            cursor: pointer;
            border: none;
            box-shadow: 0 0 12px rgba(0, 255, 255, 0.6);
        }

        /* Touch-optimized controls for mobile */
        @media (max-width: 768px) {
            .btn-primary, .btn-secondary {
                min-height: 48px; /* Minimum touch target size */
                min-width: 48px;
            }
            
            input[type=range]::-webkit-slider-thumb {
                width: 24px;
                height: 24px;
            }
            
            .phase-card {
                min-height: 60px;
                padding: 1rem;
            }
        }

        /* Metronome minimized state */
        .metronome-minimized {
            width: auto !important;
            height: auto !important;
            padding: 0.75rem !important;
        }

        /* Phase selector horizontal scroll */
        .phase-selector-container {
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .phase-selector-container::-webkit-scrollbar {
            display: none;
        }

        .phase-card-wrapper {
            min-width: 280px;
            scroll-snap-align: center;
            scroll-snap-stop: always;
        }

        /* Improved text hierarchy */
        .text-display {
            font-family: 'JetBrains Mono', monospace;
            font-feature-settings: 'tnum' 1;
        }

        /* Pulse animation for active states */
        @keyframes pulse-glow {
            0%, 100% { 
                box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
            }
            50% { 
                box-shadow: 0 0 30px rgba(0, 255, 255, 0.6);
            }
        }

        .pulse-glow {
            animation: pulse-glow 2s infinite;
        }

        /* Loading spinner */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-spinner {
            animation: spin 1s linear infinite;
        }

        /* Improved focus states for accessibility */
        *:focus {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }

        .focus-ring:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 255, 255, 0.5);
        }

        /* Smooth transitions for theme switching */
        * {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        /* Enhanced mobile responsiveness */
        @media (max-width: 640px) {
            .text-6xl { font-size: 3rem; }
            .text-7xl { font-size: 3.5rem; }
            
            .container-mobile {
                padding-left: 1rem;
                padding-right: 1rem;
            }
        }

        /* Swipe indicator */
        .swipe-indicator {
            position: relative;
        }

        .swipe-indicator::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 4px;
            background: var(--accent-primary);
            border-radius: 2px;
            opacity: 0.6;
        }

        /* Floating action button */
        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--gradient-accent);
            box-shadow: 0 4px 20px rgba(0, 255, 255, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .fab:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 255, 255, 0.6);
        }

        /* Custom dropdown styles */
        .dropdown {
            position: relative;
        }

        .dropdown-content {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            border: 1px solid var(--border-accent);
            border-radius: 12px;
            margin-top: 8px;
            box-shadow: var(--shadow-soft);
            z-index: 100;
            opacity: 0;
            transform: translateY(-10px);
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .dropdown.active .dropdown-content {
            opacity: 1;
            transform: translateY(0);
            visibility: visible;
        }

        /* Time signature display */
        .time-signature {
            font-family: 'JetBrains Mono', monospace;
            background: var(--glass-bg);
            border: 1px solid var(--border-accent);
            border-radius: 8px;
            padding: 0.5rem;
            min-width: 48px;
            text-align: center;
        }

        /* Beat visualization */
        .beat-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--text-muted);
            transition: all 0.1s ease;
        }

        .beat-indicator.active {
            background: var(--accent-primary);
            box-shadow: 0 0 12px var(--accent-primary);
            transform: scale(1.3);
        }

        .beat-indicator.accent {
            background: var(--accent-secondary);
            box-shadow: 0 0 16px var(--accent-secondary);
        }

        /* Time signature button styles */
        .time-sig-btn {
            background: var(--glass-bg);
            border: 1px solid var(--border-accent);
            border-radius: 8px;
            padding: 0.5rem;
            text-align: center;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-secondary);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .time-sig-btn:hover {
            background: var(--border-accent);
            color: var(--text-primary);
        }

        .time-sig-btn.active {
            background: var(--accent-primary);
            color: var(--primary-bg);
            border-color: var(--accent-primary);
            box-shadow: 0 0 12px rgba(0, 255, 255, 0.4);
        }

        /* Line clamp utility */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Enhanced mobile touch targets */
        @media (hover: none) {
            .btn-primary:hover, .btn-secondary:hover {
                transform: none;
            }
            
            .btn-primary:active, .btn-secondary:active {
                transform: scale(0.95);
            }
        }
    </style>
</head>
<body class="font-sans antialiased" data-theme="dark">


    <!-- 1. FIXED ONBOARDING MODAL -->
    <div id="onboarding-modal" class="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4 transition-opacity duration-300">
        <div class="bg-white rounded-2xl p-6 sm:p-8 max-w-lg w-full shadow-2xl border-2 border-gray-200">
            <div class="text-center mb-6">
                <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center">
                    <i class="fas fa-music text-white text-2xl"></i>
                </div>
                <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-2">
                    Music Study Protocol
                </h2>
                <p class="text-gray-600 text-sm">Optimitza la teva pr√†ctica musical</p>
            </div>
            
            <div class="space-y-4 mb-8">
                <div class="flex items-start space-x-3">
                    <div class="w-6 h-6 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0 mt-0.5">
                        <i class="fas fa-guitar text-blue-600 text-xs"></i>
                    </div>
                    <div>
                        <h3 class="font-medium text-gray-800">Prepara l'Instrument</h3>
                        <p class="text-sm text-gray-600">Assegura't que estigui afinat i a punt</p>
                    </div>
                </div>
                
                <div class="flex items-start space-x-3">
                    <div class="w-6 h-6 rounded-full bg-green-100 flex items-center justify-center flex-shrink-0 mt-0.5">
                        <i class="fas fa-clipboard-list text-green-600 text-xs"></i>
                    </div>
                    <div>
                        <h3 class="font-medium text-gray-800">Organitza</h3>
                        <p class="text-sm text-gray-600">Partitures, llapis i paper de notes a m√†</p>
                    </div>
                </div>
                
                <div class="flex items-start space-x-3">
                    <div class="w-6 h-6 rounded-full bg-purple-100 flex items-center justify-center flex-shrink-0 mt-0.5">
                        <i class="fas fa-lungs text-purple-600 text-xs"></i>
                    </div>
                    <div>
                        <h3 class="font-medium text-gray-800">Respiraci√≥</h3>
                        <p class="text-sm text-gray-600">Tres respiracions profundes per centrar-te</p>
                    </div>
                </div>
            </div>

            <button onclick="closeOnboardingModal()" class="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-200 transform hover:scale-105 shadow-lg">
                <i class="fas fa-play mr-2"></i>
                Comen√ßar el Protocol
            </button>
        </div>
    </div>

    <!-- 2. ENHANCED METRONOME (Advanced Features) -->
    <div id="metronome-area" class="fixed bottom-4 right-4 lg:right-8 glass rounded-2xl shadow-2xl z-20 transition-all duration-300 border border-white/20" style="width: 320px;">
        
        <!-- METRONOME HEADER -->
        <div id="metronome-header" class="flex items-center justify-between p-4 border-b border-white/10 cursor-pointer" onclick="toggleMetronomeCollapse()">
            <div id="metronome-title-expanded" class="flex items-center space-x-3">
                <div class="w-8 h-8 rounded-full bg-gradient-to-r from-cyan-400 to-emerald-400 flex items-center justify-center">
                    <i class="fas fa-drum text-white text-sm"></i>
                </div>
                <div>
                    <h3 class="text-sm font-bold text-text-primary">Metr√≤nom</h3>
                    <span id="metronome-state" class="text-xs text-text-secondary">INACTIU</span>
                </div>
            </div>
            
            <!-- MINIMIZED VIEW -->
            <div id="metronome-minimized-view" class="flex items-center space-x-3 hidden">
                <div class="flex items-center space-x-2">
                    <span id="minimized-bpm" class="text-sm font-bold text-accent-primary">100</span>
                    <span class="text-xs text-text-secondary">BPM</span>
                </div>
                <div id="minimized-time-sig" class="time-signature text-xs">4/4</div>
                <button id="metronom-play-pause-min" class="btn-primary w-8 h-8 rounded-full flex items-center justify-center">
                    <i id="min-play-icon" class="fas fa-play text-xs"></i>
                    <i id="min-pause-icon" class="fas fa-pause text-xs hidden"></i>
                </button>
            </div>
            
            <!-- COLLAPSE BUTTON -->
            <button class="p-1 rounded-lg hover:bg-white/10 transition-colors focus-ring">
                <i id="metronome-toggle-icon" class="fas fa-chevron-up text-text-secondary transform transition-transform duration-300"></i>
            </button>
        </div>
        
        <!-- EXPANDED CONTROLS -->
        <div id="metronome-controls-expanded" class="p-4 space-y-4">
            <!-- BPM CONTROLS -->
            <div class="space-y-3">
                <div class="flex items-center justify-between">
                    <label class="text-sm font-medium text-text-primary">Tempo (BPM)</label>
                    <div class="flex items-center space-x-2">
                        <button id="bpm-down" class="btn-secondary w-8 h-8 rounded-lg flex items-center justify-center">
                            <i class="fas fa-minus text-xs"></i>
                        </button>
                        <input type="number" id="bpm-input" value="100" min="40" max="200" class="w-16 px-2 py-1 text-center glass rounded-lg border border-white/20 text-text-primary text-sm focus-ring">
                        <button id="bpm-up" class="btn-secondary w-8 h-8 rounded-lg flex items-center justify-center">
                            <i class="fas fa-plus text-xs"></i>
                        </button>
                    </div>
                </div>
                <input type="range" id="bpm-slider" min="40" max="200" value="100" class="w-full">
            </div>

            <!-- TIME SIGNATURE -->
            <div class="space-y-3">
                <label class="text-sm font-medium text-text-primary">Comp√†s</label>
                <div class="grid grid-cols-4 gap-2">
                    <button class="time-sig-btn active" data-sig="4/4">4/4</button>
                    <button class="time-sig-btn" data-sig="3/4">3/4</button>
                    <button class="time-sig-btn" data-sig="2/4">2/4</button>
                    <button class="time-sig-btn" data-sig="6/8">6/8</button>
                </div>
            </div>

            <!-- BEAT VISUALIZATION -->
            <div class="space-y-3">
                <label class="text-sm font-medium text-text-primary">Beat Visual</label>
                <div id="beat-indicators" class="flex justify-center space-x-2">
                    <!-- Beat indicators will be generated by JS -->
                </div>
            </div>

            <!-- SOUND & VOLUME -->
            <div class="space-y-3">
                <div class="flex items-center justify-between">
                    <label class="text-sm font-medium text-text-primary">So</label>
                    <select id="metronome-sound" class="glass rounded-lg border border-white/20 px-2 py-1 text-sm text-text-primary focus-ring">
                        <option value="click">Click</option>
                        <option value="wood">Fusta</option>
                        <option value="beep">Beep</option>
                        <option value="tick">Tick</option>
                    </select>
                </div>
                <div class="flex items-center space-x-3">
                    <i class="fas fa-volume-down text-text-secondary text-sm"></i>
                    <input type="range" id="volume-slider" min="0" max="100" value="50" class="flex-grow">
                    <span id="volume-display" class="text-xs text-text-secondary w-8 text-right">50%</span>
                </div>
            </div>
            
            <!-- MAIN CONTROL -->
            <button id="metronom-toggle" class="btn-primary w-full py-3 font-semibold focus-ring">
                <i id="metronom-play-icon" class="fas fa-play mr-2"></i>
                <i id="metronom-pause-icon" class="fas fa-pause mr-2 hidden"></i>
                <span id="metronom-text">Iniciar</span>
            </button>
        </div>
    </div>

    <!-- 3. MAIN CONTAINER (Enhanced Mobile-First) -->
    <div class="flex flex-col min-h-screen">
        
        <!-- SIMPLIFIED HEADER -->
        <header class="container-mobile mx-auto px-4 py-6">
            <div class="text-center">
                <h1 class="text-2xl lg:text-4xl font-bold text-white mb-2 tracking-wide">
                    Music Study Protocol
                </h1>
                <div class="flex items-center justify-center space-x-6 text-sm">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-clock text-cyan-400"></i>
                        <span id="current-time-display" class="text-white font-mono">00:00:00</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="w-2 h-2 rounded-full bg-cyan-400"></div>
                        <span id="protocol-status-light" class="text-cyan-400 font-medium uppercase tracking-wider">Preparat</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-hourglass-half text-cyan-400"></i>
                        <span id="total-time-display" class="text-white font-mono">00:00:00</span>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- MAIN TIMER SECTION -->
        <main class="flex-grow flex flex-col items-center justify-center container-mobile mx-auto px-4 py-8">

            <!-- PHASE INFORMATION -->
            <div class="text-center mb-8 max-w-3xl w-full">
                <!-- Group Title -->
                <h3 id="group-titol" class="text-sm font-medium text-cyan-400 uppercase tracking-wider mb-2"></h3>
                <!-- Phase Title -->
                <h2 id="fase-titol" class="text-3xl lg:text-4xl font-bold text-white mb-4 leading-tight">
                    Preparat per Comen√ßar
                </h2>
                <!-- Phase Description -->
                <div id="fase-descripcio" class="text-gray-300 max-w-2xl mx-auto">
                    <p class="text-lg mb-3">Utilitza el seq√ºenciador inferior per triar un bloc, i premeu Play per iniciar la rutina.</p>
                    <div class="flex items-center justify-center space-x-6 text-sm text-cyan-400">
                        <span class="flex items-center space-x-2">
                            <i class="fas fa-drum"></i>
                            <span id="bpm-display">BPM: N/A</span>
                        </span>
                        <span class="flex items-center space-x-2">
                            <i class="fas fa-clock"></i>
                            <span id="phase-duration">Durada: --</span>
                        </span>
                    </div>
                </div>
            </div>
            
            <!-- SIMPLIFIED TIMER DISPLAY -->
            <div class="relative mb-8">
                <!-- Simple Progress Circle -->
                <svg id="progress-svg" class="w-48 h-48 lg:w-64 lg:h-64 transform -rotate-90" viewBox="0 0 120 120">
                    <!-- Background circle -->
                    <circle class="stroke-white/20" stroke-width="3" cx="60" cy="60" r="54" fill="transparent"></circle>
                    <!-- Progress circle -->
                    <circle id="progress-circle" class="progress-ring__circle stroke-current stroke-cyan-400 transition-all duration-500" stroke-width="3" stroke-linecap="round" cx="60" cy="60" r="54" fill="transparent" stroke-dasharray="339" stroke-dashoffset="339"></circle>
                </svg>

                <!-- Timer Display -->
                <div class="absolute inset-0 flex flex-col items-center justify-center">
                    <div id="time-display" class="text-4xl lg:text-5xl font-light text-white font-mono leading-none">00:00</div>
                    <div id="timer-status" class="text-sm text-cyan-400 uppercase tracking-wide mt-2">Inactiu</div>
                </div>
            </div>

            <!-- ENHANCED TIMER CONTROLS -->
            <div class="flex items-center space-x-4 lg:space-x-6">
                
                <!-- Previous Phase Button -->
                <button id="prev-btn" class="btn-secondary w-12 h-12 lg:w-14 lg:h-14 rounded-full flex items-center justify-center focus-ring" title="Fase anterior">
                    <i class="fas fa-step-backward text-lg"></i>
                </button>
                
                <!-- Main Play/Pause Button -->
                <button id="play-pause-btn" class="relative w-16 h-16 lg:w-20 lg:h-20 rounded-full btn-primary flex items-center justify-center shadow-2xl focus-ring group" title="Iniciar/Pausar">
                    <i id="play-icon" class="fas fa-play text-xl lg:text-2xl transition-transform group-hover:scale-110"></i>
                    <i id="pause-icon" class="fas fa-pause text-xl lg:text-2xl hidden transition-transform group-hover:scale-110"></i>
                </button>
                
                <!-- Next Phase Button -->
                <button id="next-btn" class="btn-secondary w-12 h-12 lg:w-14 lg:h-14 rounded-full flex items-center justify-center focus-ring" title="Fase seg√ºent">
                    <i class="fas fa-step-forward text-lg"></i>
                </button>
            </div>

            <!-- QUICK ACTIONS (Mobile-friendly) -->
            <div class="flex items-center space-x-3 mt-8">
                <button id="reset-btn" class="btn-secondary px-4 py-2 rounded-lg text-sm focus-ring">
                    <i class="fas fa-redo mr-2"></i>Reiniciar
                </button>
                <button id="skip-phase-btn" class="btn-secondary px-4 py-2 rounded-lg text-sm focus-ring">
                    <i class="fas fa-forward mr-2"></i>Saltar Fase
                </button>
            </div>

        </main>
        
    </div>

    <!-- 4. ENHANCED PHASE SEQUENCER -->
    <aside class="glass border-t border-white/20 mt-auto backdrop-blur-xl">
        <div class="container-mobile mx-auto px-4 py-4">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-text-primary flex items-center space-x-2">
                    <i class="fas fa-list-ol text-accent-primary"></i>
                    <span>Seq√ºenciador de Fases</span>
                </h3>
                <div class="flex items-center space-x-2 text-sm text-text-secondary">
                    <i class="fas fa-hand-paper text-xs"></i>
                    <span class="hidden sm:inline">Desliza per navegar</span>
                    <span class="sm:hidden">Desliza</span>
                </div>
            </div>
            
            <!-- Phase Cards Container -->
            <div id="fase-selector-container" class="phase-selector-container flex space-x-4 pb-4">
                <!-- Phase cards will be generated by JavaScript -->
            </div>
            
            <!-- Phase Progress Indicator -->
            <div class="flex justify-center mt-4">
                <div id="phase-progress-dots" class="flex space-x-2">
                    <!-- Progress dots will be generated by JavaScript -->
                </div>
            </div>
        </div>
    </aside>



    <!-- FOOTER -->
    <footer class="glass border-t border-white/20 backdrop-blur-xl">
        <div class="container-mobile mx-auto px-4 py-3 text-center">
            <p class="text-xs text-text-muted">
                <i class="fas fa-heart text-red-400 mr-1"></i>
                Creat per Eugeni Corchero &copy; 2025
            </p>
        </div>
    </footer>

    <script>
        // =======================================================
        // 1. STUDY PHASES DATA (Based on original CSV structure)
        // =======================================================

        const STUDY_PHASES = [
            // I. Escalfament i T√®cnica (Grup)
            {
                code: "I",
                title: "I. Escalfament i T√®cnica",
                duration: 20 * 60, // 20 minutes
                description: "Objectiu: Preparar el cos, la ment i l'instrument.",
                bpm: "",
                isGroup: true,
                backgroundClass: "bg-phase-green"
            },
            // Subfases del Grup I
            {
                code: "I.1",
                title: "Preparaci√≥ i So Fonamental",
                duration: 5 * 60, // 5 minutes
                description: "Estiraments lleugers i concentraci√≥. Toca notes llargues per centrar el teu so, fes exercicis de digitaci√≥ per connectar amb l'instrument.",
                bpm: "Focus en la qualitat del so i la respiraci√≥",
                isGroup: false,
                backgroundClass: "bg-phase-green",
                icon: "fas fa-leaf"
            },
            {
                code: "I.2",
                title: "T√®cnica Di√†ria (Escales/Arpegis)",
                duration: 15 * 60, // 15 minutes
                description: "Practica la t√®cnica amb uniformitat i precisi√≥. ESCALES - ARPEGIS - ACORDS - ESTUDIS",
                bpm: "Inici: 60-80 bpm ‚Üí Objectiu: 100-120 bpm",
                isGroup: false,
                backgroundClass: "bg-phase-green",
                icon: "fas fa-dumbbell"
            },
            // II. Treball del Repertori (Grup)
            {
                code: "II",
                title: "II. Treball del Repertori",
                duration: 40 * 60, // 40 minutes
                description: "Objectiu: Abordar les obres i resoldre els problemes t√®cnics i musicals.",
                bpm: "",
                isGroup: true,
                backgroundClass: "bg-phase-cyan"
            },
            // Subfases del Grup II
            {
                code: "II.1",
                title: "Rep√†s de la pe√ßa principal",
                duration: 10 * 60, // 10 minutes
                description: "Toca la pe√ßa o fragment que ja domines per guanyar confian√ßa i musicalitat. Recupera el que has estudiat les darreres sessions",
                bpm: "Al tempo indicat a la partitura",
                isGroup: false,
                backgroundClass: "bg-phase-cyan",
                icon: "fas fa-redo"
            },
            {
                code: "II.2",
                title: "Objectiu Principal (Passatges Dif√≠cils)",
                duration: 25 * 60, // 25 minutes
                description: "A√Ølla els errors i treballa-los amb estrat√®gies (tempo lent, per compassos, format obstinat).",
                bpm: "40-60 bpm ‚Üí 75% del tempo real",
                isGroup: false,
                backgroundClass: "bg-phase-blue",
                icon: "fas fa-target"
            },
            {
                code: "II.3",
                title: "Simulaci√≥",
                duration: 5 * 60, // 5 minutes
                description: "Toca el fragment estudiat sense aturar-te (encara que fallis). Simula una situaci√≥ d'actuaci√≥.",
                bpm: "80-100% del tempo real",
                isGroup: false,
                backgroundClass: "bg-phase-blue",
                icon: "fas fa-theater-masks"
            },
            // III. Desenvolupament i Planificaci√≥ (Grup)
            {
                code: "III",
                title: "III. Desenvolupament i Planificaci√≥",
                duration: 15 * 60, // 15 minutes
                description: "Objectiu: Desenvolupar l'o√Øda i organitzar.",
                bpm: "",
                isGroup: true,
                backgroundClass: "bg-phase-purple"
            },
            // Subfases del Grup III
            {
                code: "III.1",
                title: "Desenvolupament",
                duration: 10 * 60, // 10 minutes
                description: "Exercicis de lectura a vista senzilla, improvisaci√≥ sobre un acord/pedal/tonalitat/escala, treure frases/riffs/can√ßons d'o√Øda.",
                bpm: "Lliure",
                isGroup: false,
                backgroundClass: "bg-phase-purple",
                icon: "fas fa-brain"
            },
            {
                code: "III.2",
                title: "Planificaci√≥",
                duration: 5 * 60, // 5 minutes
                description: "Dedica 5 minuts a pensar que cal millorar per a la pr√≤xima sessi√≥ d'estudi i que far√†s de forma ordenada.",
                bpm: "No s'usa",
                isGroup: false,
                backgroundClass: "bg-phase-pink",
                icon: "fas fa-clipboard-check"
            }
        ];

        // Current state
        let currentPhaseIndex = 0;
        let timeLeft = 0;
        let isRunning = false;
        let interval;
        let totalSecondsDedicated = 0;

        // Timer and UI elements
        const timeDisplay = document.getElementById('time-display');
        const phaseTitle = document.getElementById('fase-titol');
        const groupTitle = document.getElementById('group-titol');
        const phaseDescription = document.getElementById('fase-descripcio');
        const bpmDisplay = document.getElementById('bpm-display');
        const phaseDuration = document.getElementById('phase-duration');
        const progressCircle = document.getElementById('progress-circle');
        const pulseCircle = document.getElementById('pulse-circle');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const playIcon = document.getElementById('play-icon');
        const pauseIcon = document.getElementById('pause-icon');
        const timerStatus = document.getElementById('timer-status');
        const timerStatusIndicator = document.getElementById('timer-status-indicator');
        const nextBtn = document.getElementById('next-btn');
        const prevBtn = document.getElementById('prev-btn');
        const protocolStatusLight = document.getElementById('protocol-status-light');
        const currentTimeDisplay = document.getElementById('current-time-display');
        const totalTimeDisplay = document.getElementById('total-time-display');
        const faseSelectorContainer = document.getElementById('fase-selector-container');
        const phaseProgressDots = document.getElementById('phase-progress-dots');
        
        // Calculate total circle length for progress (updated radius)
        const totalCircleLength = 2 * Math.PI * 54;

        // =======================================================
        // 2. UTILITY FUNCTIONS
        // =======================================================
        // =======================================================
        // 2. UTILITY FUNCTIONS
        // =======================================================

        function formatTime(totalSeconds) {
            const minutes = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
            const seconds = (totalSeconds % 60).toString().padStart(2, '0');
            return `${minutes}:${seconds}`;
        }

        function formatTimeWithHours(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600).toString().padStart(2, '0');
            const minutes = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
            const seconds = (totalSeconds % 60).toString().padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }

        function formatClock(date) {
            return date.toLocaleTimeString('ca-ES', { hour12: false });
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function vibrate(pattern = [100]) {
            if ('vibrate' in navigator) {
                navigator.vibrate(pattern);
            }
        }

        function showNotification(title, body, icon = 'fas fa-bell') {
            // Create custom notification if browser notifications aren't supported
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 glass rounded-lg p-4 border border-white/20 z-50 min-w-80 shadow-2xl transform translate-x-full transition-transform duration-300';
            notification.innerHTML = `
                <div class="flex items-start space-x-3">
                    <div class="w-8 h-8 rounded-full bg-accent-primary/20 flex items-center justify-center flex-shrink-0">
                        <i class="${icon} text-accent-primary text-sm"></i>
                    </div>
                    <div class="flex-1">
                        <h4 class="font-medium text-text-primary text-sm">${title}</h4>
                        <p class="text-text-secondary text-xs mt-1">${body}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-text-muted hover:text-text-primary">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Trigger animation
            setTimeout(() => notification.classList.remove('translate-x-full'), 100);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }

        // =======================================================
        // 3. THEME MANAGEMENT
        // =======================================================

        function toggleTheme() {
            currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', currentTheme);
            localStorage.setItem('music-study-theme', currentTheme);
            
            const themeIcon = document.getElementById('theme-icon');
            themeIcon.className = currentTheme === 'dark' ? 'fas fa-sun text-lg' : 'fas fa-moon text-lg';
            
            showNotification(
                'Tema canviat',
                `Activat el tema ${currentTheme === 'dark' ? 'fosc' : 'clar'}`,
                currentTheme === 'dark' ? 'fas fa-moon' : 'fas fa-sun'
            );
        }

        // =======================================================
        // 4. TIMER LOGIC
        // =======================================================

        function getCurrentPhase() {
            return STUDY_PHASES[currentPhaseIndex];
        }

        function getExecutablePhases() {
            return STUDY_PHASES.filter(phase => !phase.isGroup);
        }

        function updateClocks() {
            currentTimeDisplay.textContent = formatClock(new Date());
            totalTimeDisplay.textContent = formatTimeWithHours(totalSecondsDedicated);
            totalSecondsDedicated++;
        }

        function updateUI() {
            const executablePhases = getExecutablePhases();
            const currentExecutableIndex = executablePhases.findIndex((phase, index) => 
                STUDY_PHASES.indexOf(phase) === currentPhaseIndex);
            
            if (currentExecutableIndex === -1) return;
            
            const phase = STUDY_PHASES[currentPhaseIndex];
            const percent = timeLeft / phase.duration;
            const offset = totalCircleLength * (1 - percent);

            // Update timer display
            timeDisplay.textContent = formatTime(timeLeft);
            progressCircle.style.strokeDashoffset = offset;

            // Update phase information
            const groupPhase = findGroupForPhase(currentPhaseIndex);
            groupTitle.textContent = groupPhase ? groupPhase.title : '';
            phaseTitle.textContent = phase.title.replace(/^[IVX]+\.\d*\s*/, ''); // Remove phase number prefix
            
            // Update description
            const descriptionHTML = `
                <p class="text-lg mb-3">${phase.description}</p>
                <div class="flex items-center justify-center space-x-6 text-sm text-cyan-400">
                    <span class="flex items-center space-x-2">
                        <i class="fas fa-drum"></i>
                        <span>${phase.bpm || 'Lliure'}</span>
                    </span>
                    <span class="flex items-center space-x-2">
                        <i class="fas fa-clock"></i>
                        <span>${Math.floor(phase.duration / 60)} min</span>
                    </span>
                </div>
            `;
            phaseDescription.innerHTML = descriptionHTML;

            // Update background color
            updateBackgroundColor(phase);

            // Update status
            updateStatus();

            // Update navigation buttons
            prevBtn.disabled = currentExecutableIndex === 0;
            nextBtn.disabled = currentExecutableIndex === executablePhases.length - 1;

            // Update phase selector
            updatePhaseSelector();
            updateProgressDots();

            // Handle phase completion
            if (timeLeft === 0 && isRunning) {
                handlePhaseCompletion();
            }
        }

        function updateBackgroundColor(phase) {
            // Remove existing background classes
            document.body.classList.remove('bg-phase-green', 'bg-phase-cyan', 'bg-phase-blue', 'bg-phase-purple', 'bg-phase-pink', 'bg-phase-orange');
            
            // Add current phase background
            if (phase.backgroundClass) {
                document.body.classList.add(phase.backgroundClass);
            }
        }

        function getExecutablePhases() {
            return STUDY_PHASES.filter(phase => !phase.isGroup);
        }

        function findGroupForPhase(phaseIndex) {
            for (let i = phaseIndex; i >= 0; i--) {
                if (STUDY_PHASES[i].isGroup) {
                    return STUDY_PHASES[i];
                }
            }
            return null;
        }

        function updateUIColors(phase) {
            // Update progress circle color
            progressCircle.className = `progress-ring__circle stroke-current ${phase.color.text}`;
            
            // Update phase title color
            phaseTitle.className = `text-2xl lg:text-3xl font-bold ${phase.color.text} mb-3 leading-tight`;
        }

        function updateStatus() {
            if (isRunning) {
                timerStatus.textContent = 'Actiu';
                timerStatusIndicator.className = 'w-2 h-2 rounded-full bg-success animate-pulse';
                protocolStatusLight.textContent = 'Actiu';
                protocolStatusLight.className = 'text-xs font-medium text-success uppercase tracking-wider';
                pulseCircle.classList.remove('hidden');
            } else {
                timerStatus.textContent = 'Pausat';
                timerStatusIndicator.className = 'w-2 h-2 rounded-full bg-warning';
                protocolStatusLight.textContent = 'Pausat';
                protocolStatusLight.className = 'text-xs font-medium text-warning uppercase tracking-wider';
                pulseCircle.classList.add('hidden');
            }
        }

        function findGroupForPhase(phaseIndex) {
            for (let i = phaseIndex; i >= 0; i--) {
                if (STUDY_PHASES[i].isGroup) {
                    return STUDY_PHASES[i];
                }
            }
            return null;
        }

        function startTimer() {
            if (isRunning) return;
            
            isRunning = true;
            playIcon.classList.add('hidden');
            pauseIcon.classList.remove('hidden');
            
            interval = setInterval(() => {
                if (timeLeft > 0) {
                    timeLeft--;
                    updateUI();
                } else {
                    handlePhaseCompletion();
                }
            }, 1000);
            
            updateUI();
            showNotification('Timer iniciat', 'La teva sessi√≥ d\'estudi ha comen√ßat', 'fas fa-play');
        }

        function pauseTimer() {
            clearInterval(interval);
            isRunning = false;
            playIcon.classList.remove('hidden');
            pauseIcon.classList.add('hidden');
            updateUI();
        }

        function resetTimer() {
            pauseTimer();
            const executablePhases = getExecutablePhases();
            if (executablePhases.length > 0) {
                const currentExecutableIndex = executablePhases.findIndex(phase => 
                    STUDY_PHASES.indexOf(phase) === currentPhaseIndex);
                if (currentExecutableIndex !== -1) {
                    timeLeft = executablePhases[currentExecutableIndex].duration;
                    updateUI();
                }
            }
        }

        function handlePhaseCompletion() {
            clearInterval(interval);
            isRunning = false;
            
            playSuccessSound();
            vibrate([200, 100, 200]);
            
            const executablePhases = getExecutablePhases();
            const currentExecutableIndex = executablePhases.findIndex(phase => 
                STUDY_PHASES.indexOf(phase) === currentPhaseIndex);
            
            if (currentExecutableIndex < executablePhases.length - 1) {
                // Move to next executable phase
                const nextPhase = executablePhases[currentExecutableIndex + 1];
                currentPhaseIndex = STUDY_PHASES.indexOf(nextPhase);
                timeLeft = nextPhase.duration;
                
                showNotification(
                    'Fase completada!',
                    `Seg√ºent: ${nextPhase.title}`,
                    'fas fa-check-circle'
                );
                
                // Auto-start next phase after 3 seconds
                setTimeout(() => {
                    if (!isRunning) {
                        startTimer();
                    }
                }, 3000);
            } else {
                // Routine completed
                completeRoutine();
            }
            
            updateUI();
        }

        function completeRoutine() {
            timerStatus.textContent = 'Completat';
            timerStatusIndicator.className = 'w-2 h-2 rounded-full bg-success';
            protocolStatusLight.textContent = 'Completat';
            protocolStatusLight.className = 'text-xs font-medium text-success uppercase tracking-wider';
            
            phaseTitle.textContent = 'Rutina Completada!';
            groupTitle.textContent = 'Felicitats!';
            phaseDescription.innerHTML = `
                <p class="text-base mb-3">Has completat tota la rutina d'estudi. Bon treball!</p>
                <div class="flex items-center justify-center space-x-4 text-sm">
                    <span class="flex items-center space-x-1">
                        <i class="fas fa-trophy text-accent-primary text-xs"></i>
                        <span>Objectiu assolit</span>
                    </span>
                </div>
            `;
            
            showNotification(
                'Rutina completada!',
                'Has completat tota la sessi√≥ d\'estudi. Molt b√©!',
                'fas fa-trophy'
            );
            
            playCompletionSound();
            vibrate([300, 100, 300, 100, 300]);
        }
        // =======================================================
        // 5. ENHANCED AUDIO SYSTEM
        // =======================================================

        let audioContext;
        
        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            return audioContext;
        }

        function playSuccessSound() {
            try {
                const ctx = initAudioContext();
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);
                
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(523.25, ctx.currentTime); // C5
                oscillator.frequency.setValueAtTime(659.25, ctx.currentTime + 0.1); // E5
                oscillator.frequency.setValueAtTime(783.99, ctx.currentTime + 0.2); // G5
                
                gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.6);
                
                oscillator.start();
                oscillator.stop(ctx.currentTime + 0.6);
            } catch (error) {
                console.error("Error playing success sound:", error);
            }
        }

        function playCompletionSound() {
            try {
                const ctx = initAudioContext();
                const frequencies = [523.25, 659.25, 783.99, 1046.50]; // C-E-G-C
                
                frequencies.forEach((freq, index) => {
                    const oscillator = ctx.createOscillator();
                    const gainNode = ctx.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(ctx.destination);
                    
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(freq, ctx.currentTime + index * 0.2);
                    
                    gainNode.gain.setValueAtTime(0.2, ctx.currentTime + index * 0.2);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + index * 0.2 + 0.5);
                    
                    oscillator.start(ctx.currentTime + index * 0.2);
                    oscillator.stop(ctx.currentTime + index * 0.2 + 0.5);
                });
            } catch (error) {
                console.error("Error playing completion sound:", error);
            }
        }

        // =======================================================
        // 6. ENHANCED METRONOME SYSTEM
        // =======================================================

        let metronomeAudioContext;
        let metronomeInterval;
        let metronomeIsRunning = false;
        let currentBPM = 100;
        let currentTimeSignature = { beats: 4, noteValue: 4 };
        let beatCount = 0;
        let metronomeVolume = 0.5;
        let metronomeSound = 'click';
        let isMetronomeCollapsed = window.innerWidth < 1024;

        // Metronome DOM elements
        const metronomeArea = document.getElementById('metronome-area');
        const metronomeToggleIcon = document.getElementById('metronome-toggle-icon');
        const metronomeControlsExpanded = document.getElementById('metronome-controls-expanded');
        const metronomeMinimizedView = document.getElementById('metronome-minimized-view');
        const metronomeToggle = document.getElementById('metronom-toggle');
        const metronomePlayPauseMin = document.getElementById('metronom-play-pause-min');
        const metronomeState = document.getElementById('metronome-state');
        const minimizedBPM = document.getElementById('minimized-bpm');
        const minimizedTimeSig = document.getElementById('minimized-time-sig');
        const bpmInput = document.getElementById('bpm-input');
        const bpmSlider = document.getElementById('bpm-slider');
        const bpmUpBtn = document.getElementById('bpm-up');
        const bpmDownBtn = document.getElementById('bpm-down');
        const volumeSlider = document.getElementById('volume-slider');
        const volumeDisplay = document.getElementById('volume-display');
        const metronomeSoundSelect = document.getElementById('metronome-sound');
        const beatIndicators = document.getElementById('beat-indicators');
        const metronomePlayIcon = document.getElementById('metronom-play-icon');
        const metronomePauseIcon = document.getElementById('metronom-pause-icon');
        const metronomeText = document.getElementById('metronom-text');

        // Sound generation functions for different metronome sounds
        const metronomeSounds = {
            click: (ctx, time, isAccent) => {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                
                osc.connect(gain);
                gain.connect(ctx.destination);
                
                osc.type = 'square';
                osc.frequency.setValueAtTime(isAccent ? 1200 : 800, time);
                
                gain.gain.setValueAtTime(metronomeVolume * 0.3, time);
                gain.gain.exponentialRampToValueAtTime(0.001, time + 0.1);
                
                osc.start(time);
                osc.stop(time + 0.1);
            },
            
            wood: (ctx, time, isAccent) => {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                const filter = ctx.createBiquadFilter();
                
                osc.connect(filter);
                filter.connect(gain);
                gain.connect(ctx.destination);
                
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(isAccent ? 800 : 400, time);
                
                filter.type = 'bandpass';
                filter.frequency.setValueAtTime(isAccent ? 2000 : 1000, time);
                filter.Q.setValueAtTime(10, time);
                
                gain.gain.setValueAtTime(metronomeVolume * 0.4, time);
                gain.gain.exponentialRampToValueAtTime(0.001, time + 0.05);
                
                osc.start(time);
                osc.stop(time + 0.05);
            },
            
            beep: (ctx, time, isAccent) => {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                
                osc.connect(gain);
                gain.connect(ctx.destination);
                
                osc.type = 'sine';
                osc.frequency.setValueAtTime(isAccent ? 1000 : 600, time);
                
                gain.gain.setValueAtTime(metronomeVolume * 0.2, time);
                gain.gain.exponentialRampToValueAtTime(0.001, time + 0.2);
                
                osc.start(time);
                osc.stop(time + 0.2);
            },
            
            tick: (ctx, time, isAccent) => {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                const filter = ctx.createBiquadFilter();
                
                osc.connect(filter);
                filter.connect(gain);
                gain.connect(ctx.destination);
                
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(isAccent ? 2000 : 1500, time);
                
                filter.type = 'highpass';
                filter.frequency.setValueAtTime(800, time);
                
                gain.gain.setValueAtTime(metronomeVolume * 0.3, time);
                gain.gain.exponentialRampToValueAtTime(0.001, time + 0.03);
                
                osc.start(time);
                osc.stop(time + 0.03);
            }
        };

        function createMetronomeClick(time, isAccent) {
            if (!metronomeAudioContext) return;
            
            const soundFunction = metronomeSounds[metronomeSound] || metronomeSounds.click;
            soundFunction(metronomeAudioContext, time, isAccent);
        }

        function metronomeTick() {
            if (!metronomeIsRunning) return;
            
            beatCount = (beatCount % currentTimeSignature.beats) + 1;
            const isAccent = beatCount === 1;

            try {
                if (!metronomeAudioContext) {
                    metronomeAudioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                if (metronomeAudioContext.state === 'suspended') {
                    metronomeAudioContext.resume();
                }
                
                const now = metronomeAudioContext.currentTime;
                createMetronomeClick(now, isAccent);
            } catch (error) {
                console.warn("Error creating metronome click:", error);
            }
            
            updateBeatIndicators(beatCount, isAccent);
        }

        function updateBeatIndicators(currentBeat, isAccent) {
            const indicators = beatIndicators.querySelectorAll('.beat-indicator');
            indicators.forEach((indicator, index) => {
                indicator.classList.remove('active', 'accent');
                if (index + 1 === currentBeat) {
                    indicator.classList.add('active');
                    if (isAccent) {
                        indicator.classList.add('accent');
                    }
                }
            });
        }

        function createBeatIndicators() {
            beatIndicators.innerHTML = '';
            for (let i = 0; i < currentTimeSignature.beats; i++) {
                const indicator = document.createElement('div');
                indicator.className = 'beat-indicator';
                beatIndicators.appendChild(indicator);
            }
        }

        function updateMetronomeInterval() {
            if (metronomeIsRunning) {
                clearInterval(metronomeInterval);
                const secondsPerBeat = 60 / currentBPM;
                const delay = secondsPerBeat * 1000;
                metronomeInterval = setInterval(metronomeTick, delay);
            }
        }

        function startMetronome() {
            if (metronomeIsRunning) return;
            
            metronomeIsRunning = true;
            beatCount = 0;
            
            updateMetronomeInterval();
            
            // Update UI
            metronomeState.textContent = 'ACTIU';
            metronomeState.className = 'text-xs text-success';
            
            metronomePlayIcon.classList.add('hidden');
            metronomePauseIcon.classList.remove('hidden');
            metronomeText.textContent = 'Aturar';
            
            const minPlayIcon = document.getElementById('min-play-icon');
            const minPauseIcon = document.getElementById('min-pause-icon');
            minPlayIcon.classList.add('hidden');
            minPauseIcon.classList.remove('hidden');
            
            showNotification('Metr√≤nom iniciat', `${currentBPM} BPM en ${currentTimeSignature.beats}/${currentTimeSignature.noteValue}`, 'fas fa-drum');
        }

        function stopMetronome() {
            if (!metronomeIsRunning) return;
            
            clearInterval(metronomeInterval);
            metronomeIsRunning = false;
            
            // Update UI
            metronomeState.textContent = 'INACTIU';
            metronomeState.className = 'text-xs text-text-secondary';
            
            metronomePlayIcon.classList.remove('hidden');
            metronomePauseIcon.classList.add('hidden');
            metronomeText.textContent = 'Iniciar';
            
            const minPlayIcon = document.getElementById('min-play-icon');
            const minPauseIcon = document.getElementById('min-pause-icon');
            minPlayIcon.classList.remove('hidden');
            minPauseIcon.classList.add('hidden');
            
            // Reset beat indicators
            const indicators = beatIndicators.querySelectorAll('.beat-indicator');
            indicators.forEach(indicator => {
                indicator.classList.remove('active', 'accent');
            });
        }

        function toggleMetronomeCollapse() {
            isMetronomeCollapsed = !isMetronomeCollapsed;
            
            if (isMetronomeCollapsed) {
                metronomeArea.classList.add('metronome-minimized');
                metronomeControlsExpanded.classList.add('hidden');
                metronomeMinimizedView.classList.remove('hidden');
                metronomeToggleIcon.classList.add('rotate-180');
                metronomeArea.style.width = 'auto';
            } else {
                metronomeArea.classList.remove('metronome-minimized');
                metronomeControlsExpanded.classList.remove('hidden');
                metronomeMinimizedView.classList.add('hidden');
                metronomeToggleIcon.classList.remove('rotate-180');
                metronomeArea.style.width = '320px';
            }
        }

        function updateBPM(newBPM) {
            newBPM = Math.max(40, Math.min(200, parseInt(newBPM)));
            currentBPM = newBPM;
            
            bpmInput.value = currentBPM;
            bpmSlider.value = currentBPM;
            minimizedBPM.textContent = currentBPM;
            
            if (metronomeIsRunning) {
                updateMetronomeInterval();
            }
        }

        function updateVolume(newVolumePercent) {
            metronomeVolume = parseFloat(newVolumePercent) / 100;
            volumeDisplay.textContent = `${newVolumePercent}%`;
        }

        function setTimeSignature(sig) {
            const [beats, noteValue] = sig.split('/').map(Number);
            currentTimeSignature = { beats, noteValue };
            
            // Update UI
            document.querySelectorAll('.time-sig-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.sig === sig) {
                    btn.classList.add('active');
                }
            });
            
            minimizedTimeSig.textContent = sig;
            createBeatIndicators();
            
            if (metronomeIsRunning) {
                beatCount = 0; // Reset beat count when changing time signature
            }
        }

        // =======================================================
        // 7. PHASE SELECTOR & NAVIGATION
        // =======================================================

        function buildPhaseSelector() {
            faseSelectorContainer.innerHTML = '';
            
            STUDY_PHASES.forEach((phase, index) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'phase-card-wrapper flex-shrink-0';

                const card = document.createElement('div');
                card.className = 'phase-card bg-white/10 backdrop-blur-sm rounded-xl border border-white/20 transition-all duration-300 cursor-pointer hover:border-cyan-400/50 hover:bg-white/15';
                card.setAttribute('data-index', index);
                
                const timeMin = Math.floor(phase.duration / 60);
                
                if (phase.isGroup) {
                    // Group phase card
                    card.innerHTML = `
                        <div class="p-4 text-center opacity-70">
                            <div class="w-8 h-8 mx-auto mb-2 rounded-full bg-white/20 flex items-center justify-center">
                                <i class="fas fa-folder text-white text-sm"></i>
                            </div>
                            <h4 class="text-xs font-medium text-white/60 uppercase tracking-wider mb-1">${phase.code} - ${timeMin} min total</h4>
                            <p class="text-sm font-semibold text-white">${phase.title.split('.').slice(1).join('.').trim()}</p>
                        </div>
                    `;
                    card.classList.add('cursor-default');
                } else {
                    // Regular phase card
                    card.innerHTML = `
                        <div class="p-4">
                            <div class="flex items-center justify-between mb-3">
                                <div class="w-8 h-8 rounded-full bg-gradient-to-r from-cyan-400 to-blue-500 flex items-center justify-center">
                                    <i class="${phase.icon || 'fas fa-play'} text-white text-sm"></i>
                                </div>
                                <span class="text-xs font-medium text-cyan-400">${timeMin} min</span>
                            </div>
                            <h4 class="text-sm font-semibold text-white mb-2 leading-tight">${phase.title.replace(/^[IVX]+\.\d*\s*/, '')}</h4>
                            <p class="text-xs text-gray-300 line-clamp-2">${phase.description.substring(0, 60)}...</p>
                            <div class="mt-3 pt-3 border-t border-white/20 flex items-center justify-between text-xs">
                                <span class="text-gray-400">BPM: ${phase.bpm ? (phase.bpm.length > 12 ? phase.bpm.substring(0, 12) + '...' : phase.bpm) : 'Lliure'}</span>
                                <span class="text-cyan-400 font-medium">${phase.code}</span>
                            </div>
                        </div>
                    `;
                    
                    card.addEventListener('click', () => changePhase(index));
                }
                
                wrapper.appendChild(card);
                faseSelectorContainer.appendChild(wrapper);
            });
        }

        function updatePhaseSelector() {
            const cards = faseSelectorContainer.querySelectorAll('.phase-card');
            
            cards.forEach((card, index) => {
                const phase = STUDY_PHASES[index];
                card.classList.remove('border-cyan-400', 'bg-cyan-400/20', 'border-white/20');
                
                if (index === currentPhaseIndex && !phase.isGroup) {
                    card.classList.add('border-cyan-400', 'bg-cyan-400/20');
                } else {
                    card.classList.add('border-white/20');
                }
            });
        }

        function updateProgressDots() {
            const executablePhases = getExecutablePhases();
            phaseProgressDots.innerHTML = '';
            
            executablePhases.forEach((phase, index) => {
                const dot = document.createElement('div');
                const phaseIndex = STUDY_PHASES.indexOf(phase);
                
                dot.className = `w-2 h-2 rounded-full transition-colors duration-300 ${
                    phaseIndex === currentPhaseIndex ? 'bg-cyan-400' : 
                    phaseIndex < currentPhaseIndex ? 'bg-green-400' : 'bg-white/30'
                }`;
                
                phaseProgressDots.appendChild(dot);
            });
        }

        function changePhase(index) {
            const phase = STUDY_PHASES[index];
            if (!phase || phase.isGroup) return;

            pauseTimer();
            currentPhaseIndex = index;
            timeLeft = phase.duration;
            updateUI();
            scrollToPhase(index);
        }

        function scrollToPhase(index) {
            const card = faseSelectorContainer.querySelector(`[data-index="${index}"]`);
            if (card) {
                const wrapper = card.parentElement;
                if (wrapper) {
                    faseSelectorContainer.scrollTo({
                        left: wrapper.offsetLeft - (faseSelectorContainer.clientWidth / 2) + (wrapper.clientWidth / 2),
                        behavior: 'smooth'
                    });
                }
            }
        }

        // =======================================================
        // 8. ROUTINE MANAGEMENT
        // =======================================================

        function loadRoutine(routineId) {
            let routine;
            
            if (routineId === 'default') {
                routine = DEFAULT_ROUTINE;
            } else if (ROUTINE_TEMPLATES[routineId]) {
                routine = ROUTINE_TEMPLATES[routineId];
            } else {
                // Try to load from localStorage
                const savedRoutines = JSON.parse(localStorage.getItem('music-study-routines') || '{}');
                routine = savedRoutines[routineId];
            }
            
            if (!routine) {
                showNotification('Error', 'No s\'ha pogut carregar la rutina', 'fas fa-exclamation-triangle');
                return;
            }
            
            // Reset to first executable phase
            const executablePhases = getExecutablePhases();
            if (executablePhases.length > 0) {
                currentPhaseIndex = STUDY_PHASES.indexOf(executablePhases[0]);
                timeLeft = executablePhases[0].duration;
            }
            
            // Update UI
            buildPhaseSelector();
            updateUI();
            
            showNotification('Rutina carregada', `${routine.name} - ${Math.floor(routine.totalTime / 60)} min`, 'fas fa-check');
        }

        function saveCustomRoutine(routine) {
            const savedRoutines = JSON.parse(localStorage.getItem('music-study-routines') || '{}');
            savedRoutines[routine.id] = routine;
            localStorage.setItem('music-study-routines', JSON.stringify(savedRoutines));
        }

        function createCustomRoutine() {
            const modal = document.getElementById('custom-routine-modal');
            modal.classList.remove('hidden');
            
            // Initialize with empty routine
            document.getElementById('routine-name').value = '';
            document.getElementById('custom-phases-list').innerHTML = '';
        }

        function addCustomPhase() {
            const phasesList = document.getElementById('custom-phases-list');
            const phaseIndex = phasesList.children.length + 1;
            
            const phaseDiv = document.createElement('div');
            phaseDiv.className = 'glass rounded-lg p-4 border border-white/20';
            phaseDiv.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <h4 class="font-medium text-text-primary">Fase ${phaseIndex}</h4>
                    <button class="btn-secondary w-8 h-8 rounded-lg flex items-center justify-center remove-phase-btn">
                        <i class="fas fa-trash text-sm"></i>
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-medium text-text-secondary mb-1">T√≠tol</label>
                        <input type="text" class="phase-title w-full glass rounded border border-white/20 px-2 py-1 text-sm text-text-primary focus-ring" placeholder="Nom de la fase">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-text-secondary mb-1">Durada (minuts)</label>
                        <input type="number" class="phase-duration w-full glass rounded border border-white/20 px-2 py-1 text-sm text-text-primary focus-ring" min="1" max="120" value="10">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-xs font-medium text-text-secondary mb-1">Descripci√≥</label>
                        <textarea class="phase-description w-full glass rounded border border-white/20 px-2 py-1 text-sm text-text-primary focus-ring" rows="2" placeholder="Descripci√≥ de la fase"></textarea>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-text-secondary mb-1">BPM</label>
                        <input type="text" class="phase-bpm w-full glass rounded border border-white/20 px-2 py-1 text-sm text-text-primary focus-ring" placeholder="Ex: 60-120 bpm">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-text-secondary mb-1">Icona</label>
                        <select class="phase-icon w-full glass rounded border border-white/20 px-2 py-1 text-sm text-text-primary focus-ring">
                            <option value="fas fa-play">Play</option>
                            <option value="fas fa-dumbbell">T√®cnica</option>
                            <option value="fas fa-music">M√∫sica</option>
                            <option value="fas fa-target">Objectiu</option>
                            <option value="fas fa-brain">Creativitat</option>
                            <option value="fas fa-redo">Rep√†s</option>
                            <option value="fas fa-theater-masks">Simulaci√≥</option>
                        </select>
                    </div>
                </div>
            `;
            
            phasesList.appendChild(phaseDiv);
            
            // Add remove functionality
            phaseDiv.querySelector('.remove-phase-btn').addEventListener('click', () => {
                phaseDiv.remove();
                updatePhaseNumbers();
            });
        }

        function updatePhaseNumbers() {
            const phases = document.querySelectorAll('#custom-phases-list > div');
            phases.forEach((phase, index) => {
                phase.querySelector('h4').textContent = `Fase ${index + 1}`;
            });
        }

        // =======================================================
        // 9. EVENT HANDLERS & INITIALIZATION
        // =======================================================

        function setupEventHandlers() {
            // Theme toggle
            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
            
            // Main timer controls
            playPauseBtn.addEventListener('click', () => {
                if (isRunning) {
                    pauseTimer();
                } else {
                    startTimer();
                }
            });
            
            nextBtn.addEventListener('click', () => {
                const executablePhases = getExecutablePhases();
                const currentIndex = executablePhases.findIndex(phase => 
                    STUDY_PHASES.indexOf(phase) === currentPhaseIndex);
                if (currentIndex < executablePhases.length - 1) {
                    const nextPhase = executablePhases[currentIndex + 1];
                    changePhase(STUDY_PHASES.indexOf(nextPhase));
                }
            });
            
            prevBtn.addEventListener('click', () => {
                const executablePhases = getExecutablePhases();
                const currentIndex = executablePhases.findIndex(phase => 
                    STUDY_PHASES.indexOf(phase) === currentPhaseIndex);
                if (currentIndex > 0) {
                    const prevPhase = executablePhases[currentIndex - 1];
                    changePhase(STUDY_PHASES.indexOf(prevPhase));
                }
            });
            
            document.getElementById('reset-btn').addEventListener('click', resetTimer);
            document.getElementById('skip-phase-btn').addEventListener('click', () => {
                handlePhaseCompletion();
            });
            
            // Routine selector
            document.getElementById('routine-selector').addEventListener('click', () => {
                document.querySelector('.dropdown').classList.toggle('active');
            });
            
            document.querySelectorAll('.routine-option').forEach(option => {
                option.addEventListener('click', () => {
                    loadRoutine(option.dataset.routine);
                    document.querySelector('.dropdown').classList.remove('active');
                });
            });
            
            document.getElementById('create-routine-btn').addEventListener('click', () => {
                createCustomRoutine();
                document.querySelector('.dropdown').classList.remove('active');
            });
            
            // Custom routine modal
            document.getElementById('close-routine-modal').addEventListener('click', () => {
                document.getElementById('custom-routine-modal').classList.add('hidden');
            });
            
            document.getElementById('add-phase-btn').addEventListener('click', addCustomPhase);
            
            document.getElementById('save-routine-btn').addEventListener('click', () => {
                const name = document.getElementById('routine-name').value.trim();
                if (!name) {
                    showNotification('Error', 'Si us plau, introdueix un nom per la rutina', 'fas fa-exclamation-triangle');
                    return;
                }
                
                const phases = [];
                const phaseElements = document.querySelectorAll('#custom-phases-list > div');
                let totalTime = 0;
                
                phaseElements.forEach((phaseEl, index) => {
                    const title = phaseEl.querySelector('.phase-title').value.trim();
                    const duration = parseInt(phaseEl.querySelector('.phase-duration').value) * 60;
                    const description = phaseEl.querySelector('.phase-description').value.trim();
                    const bpm = phaseEl.querySelector('.phase-bpm').value.trim();
                    const icon = phaseEl.querySelector('.phase-icon').value;
                    
                    if (title && duration > 0) {
                        phases.push({
                            id: `C.${index + 1}`,
                            code: `C.${index + 1}`,
                            title: title,
                            duration: duration,
                            description: description || 'Fase personalitzada',
                            bpm: bpm || 'Lliure',
                            isGroup: false,
                            color: { main: 'purple', text: 'text-purple-400', bg: 'bg-purple-900/50' },
                            icon: icon
                        });
                        totalTime += duration;
                    }
                });
                
                if (phases.length === 0) {
                    showNotification('Error', 'Si us plau, afegeix almenys una fase v√†lida', 'fas fa-exclamation-triangle');
                    return;
                }
                
                const routine = {
                    id: `custom_${Date.now()}`,
                    name: name,
                    description: `Rutina personalitzada de ${Math.floor(totalTime / 60)} minuts`,
                    totalTime: totalTime,
                    phases: phases
                };
                
                saveCustomRoutine(routine);
                loadRoutine(routine.id);
                document.getElementById('custom-routine-modal').classList.add('hidden');
                
                showNotification('Rutina creada', `${name} s'ha guardat correctament`, 'fas fa-check');
            });
            
            document.getElementById('cancel-routine-btn').addEventListener('click', () => {
                document.getElementById('custom-routine-modal').classList.add('hidden');
            });
            
            // Metronome controls
            metronomeToggle.addEventListener('click', () => {
                metronomeIsRunning ? stopMetronome() : startMetronome();
            });
            
            metronomePlayPauseMin.addEventListener('click', () => {
                metronomeIsRunning ? stopMetronome() : startMetronome();
            });
            
            bpmInput.addEventListener('input', (e) => updateBPM(e.target.value));
            bpmSlider.addEventListener('input', (e) => updateBPM(e.target.value));
            bpmUpBtn.addEventListener('click', () => updateBPM(currentBPM + 5));
            bpmDownBtn.addEventListener('click', () => updateBPM(currentBPM - 5));
            
            volumeSlider.addEventListener('input', (e) => updateVolume(e.target.value));
            metronomeSoundSelect.addEventListener('change', (e) => {
                metronomeSound = e.target.value;
            });
            
            // Time signature buttons
            document.querySelectorAll('.time-sig-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    setTimeSignature(btn.dataset.sig);
                });
            });
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.dropdown')) {
                    document.querySelectorAll('.dropdown').forEach(dropdown => {
                        dropdown.classList.remove('active');
                    });
                }
            });
        }

        function closeOnboardingModal() {
            const modal = document.getElementById('onboarding-modal');
            modal.classList.add('opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        function initialize() {
            // Initialize theme icon
            const themeIcon = document.getElementById('theme-icon');
            themeIcon.className = currentTheme === 'dark' ? 'fas fa-sun text-lg' : 'fas fa-moon text-lg';
            
            // Initialize metronome
            if (window.innerWidth < 1024) {
                toggleMetronomeCollapse();
            }
            createBeatIndicators();
            setTimeSignature('4/4');
            updateBPM(currentBPM);
            updateVolume(metronomeVolume * 100);
            
            // Initialize timer
            const executablePhases = getExecutablePhases();
            if (executablePhases.length > 0) {
                currentPhaseIndex = STUDY_PHASES.indexOf(executablePhases[0]);
                timeLeft = executablePhases[0].duration;
            }
            
            // Initialize UI
            progressCircle.style.strokeDasharray = totalCircleLength;
            progressCircle.style.strokeDashoffset = totalCircleLength;
            
            buildPhaseSelector();
            updateUI();
            
            // Setup event handlers
            setupEventHandlers();
            
            // Start clocks
            setInterval(updateClocks, 1000);
            updateClocks();
            
            // Add initial phase to the custom routine modal
            addCustomPhase();
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initialize);
        
        // Handle visibility change to pause/resume appropriately
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && isRunning) {
                // Page is hidden, could pause timer here if desired
            } else if (!document.hidden && isRunning) {
                // Page is visible again, timer continues
            }
        });

    </script>
</body>
</html>
