<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Study Protocol - Temporitzador i Metrònom Focus</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Configuració global del fons i la font */
        body {
            background-color: #0d0d1a; 
            font-family: 'Inter', sans-serif;
            transition: background-color 0.5s ease-in-out;
            min-height: 100vh;
        }
        
        /* Oculta la barra de desplaçament del cos, però permet-la a seccions específiques */
        ::-webkit-scrollbar { display: none; }
        
        /* Estils del Cercle de Progrés (SVG) */
        .progress-ring__circle {
            transition: stroke-dashoffset 0.5s ease-in-out;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
        
        /* Estil futurista per al slider (Accent: Cyan) */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 1rem; 
            height: 1rem; 
            border-radius: 50%;
            background: #00ffff; 
            cursor: pointer;
            box-shadow: 0 0 12px rgba(0, 255, 255, 0.8);
            margin-top: -6px; 
        }
        input[type=range]::-moz-range-thumb {
            width: 1rem; 
            height: 1rem; 
            border-radius: 50%;
            background: #00ffff;
            cursor: pointer;
            box-shadow: 0 0 12px rgba(0, 255, 255, 0.8);
        }
        input[type=range] {
            height: 6px;
            background: #2a2a4a; 
        }

        /* Estil per al Metrònom Minimitzat */
        .metronom-minimized {
            width: auto !important;
            height: auto !important;
            padding: 0.5rem !important;
        }

        /* Estil per al Seqüenciador de Fases Inferior (Scroll horitzontal) */
        #fase-selector-container {
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
        }
        .fase-btn-wrapper {
            /* Amplada mínima per mantenir la claredat dels títols llargs */
            min-width: 18rem; 
            scroll-snap-align: center;
        }

        /* Millora de l'espaiat i la llegibilitat de les fases centrals */
        #fase-titol {
            line-height: 1.2;
        }
        #fase-descripcio .bpm-text {
            /* Text petit i monoespaiat per als BPM */
            font-size: 0.75rem; 
        }
    </style>
</head>
<body class="flex flex-col font-sans antialiased transition-colors duration-500 text-gray-100">

    <!-- 1. POP-UP D'INICI (MODAL D'ONBOARDING) -->
    <div id="onboarding-modal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 transition-opacity duration-300">
        <div class="bg-gray-900 border border-cyan-400/50 rounded-xl p-8 max-w-lg w-full shadow-2xl shadow-cyan-500/10">
            <h2 class="text-3xl font-extrabold text-cyan-400 mb-4 tracking-wider">PROTOCOL D'INICI DE PRÀCTICA</h2>
            <p class="text-gray-300 mb-6">Abans de començar la teva rutina <b>Music Study Protocol</b>, assegura't que el teu entorn estigui optimitzat:</p>
            
            <ul class="space-y-3 text-sm text-gray-400 list-inside list-disc">
                <li><b>Prepara l'Instrument</b>: A punt i afinat.</li>
                <li><b>Organitza</b>: Partitures, llapis, goma i paper de notes a mà.</li>
                <li><b>Respiració</b>: Fes tres respiracions profundes per centrar la teva ment.</li>
            </ul>

            <button onclick="closeOnboardingModal()" class="mt-8 w-full py-3 bg-cyan-600 text-gray-900 font-bold rounded-lg hover:bg-cyan-500 transition duration-200 shadow-md shadow-cyan-500/30">
                COMENÇAR EL PROTOCOL
            </button>
        </div>
    </div>

    <!-- 2. METRÒNOM (COMPONENT FLOTANT MINIMITZABLE) -->
    <div id="metronome-area" class="fixed bottom-4 right-4 lg:right-8 p-3 w-64 bg-gray-900/90 border border-[#00ffff]/30 rounded-xl shadow-2xl shadow-[#00ffff]/10 z-20 backdrop-blur-sm transition-all duration-300">
        
        <!-- HEADER DEL METRÒNOM (Sempre visible, conté toggle i play/pause) -->
        <div id="metronome-header" class="flex items-center justify-between pb-1 border-b border-gray-700/50 mb-2 cursor-pointer" onclick="toggleMetronomeCollapse()">
            <div id="metronome-title-expanded" class="flex items-center space-x-2">
                <h3 class="text-xs font-bold uppercase tracking-widest text-[#00ffff]">Metrònom</h3>
                <span id="metronome-state" class="text-xs font-mono text-gray-500 border border-gray-700 rounded px-1 hidden lg:block">INACTIU</span>
            </div>
            
            <!-- Versió minimitzada (Només visible quan està col·lapsat) -->
            <div id="metronome-minimized-view" class="flex items-center space-x-2 hidden">
                <span id="minimized-bpm" class="text-sm font-bold text-[#00ff00]">100 BPM</span>
                <button id="metronom-play-pause-min" class="p-1 rounded-full bg-cyan-600 hover:bg-cyan-500 text-gray-900 transition duration-200">
                    <svg id="min-play-icon" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>
                    <svg id="min-stop-icon" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 hidden" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                </button>
            </div>
            
            <!-- Botó per col·lapsar -->
            <svg id="metronome-toggle-icon" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500 transform rotate-0 transition duration-300" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
        </div>
        
        <!-- CONTROLS EXPANDITS (Es col·lapsen) -->
        <div id="metronome-controls-expanded">
             <!-- CONTROLS BPM -->
            <div class="flex items-center space-x-2 mb-3">
                <input type="number" id="bpm-input" value="100" min="40" max="150" class="w-12 p-1 text-center bg-gray-950 rounded border border-[#00ffff]/50 text-[#00ffff] font-bold text-xs">
                <span class="text-gray-400 text-xs">BPM</span>
                <input type="range" id="bpm-slider" min="40" max="150" value="100" class="flex-grow h-2 rounded-lg appearance-none cursor-pointer">
            </div>

            <!-- CONTROLS VOLUM -->
            <div class="flex items-center space-x-2 mb-3">
                <span class="text-gray-400 text-xs w-12">Volum</span>
                <input type="range" id="volume-slider" min="0" max="100" value="50" class="flex-grow h-2 rounded-lg appearance-none cursor-pointer">
                <span id="volume-display" class="text-gray-400 text-xs w-8 text-right">50%</span>
            </div>
            
            <!-- INDICADOR VISUAL i TOGGLE PRINCIPAL -->
            <div class="flex items-center justify-between pt-1">
                <div class="flex items-center space-x-2">
                    <span class="text-gray-500 text-xs">Beat Actiu:</span>
                    <div id="metronom-visual" class="w-3 h-3 rounded-full bg-gray-700 transition-colors duration-100"></div>
                </div>
                <!-- Aquest botó controla el metrònom quan està EXPANDIT -->
                <button id="metronom-toggle" class="p-2 rounded-full bg-[#00ffff] hover:bg-cyan-500 text-gray-900 transition duration-200 shadow-md shadow-[#00ffff]/30 w-10 h-10 flex items-center justify-center" title="Inicia/Atura el metrònom">
                    <svg id="metronom-play-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>
                    <svg id="metronom-stop-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                </button>
            </div>
        </div>
    </div>

    <!-- 3. CONTENIDOR PRINCIPAL (Temporitzador central) -->
    <div class="flex flex-col flex-grow w-full max-w-7xl mx-auto p-4 lg:p-8">
        
        <!-- Capçalera Simplificada i Panell d'Estat -->
        <header class="w-full mx-auto">
            <div class="flex flex-col md:flex-row items-center justify-between p-2 lg:p-4 border-b border-gray-700/50 mb-8">
                
                <!-- METRIQUES DE TEMPS (Esquerra) -->
                <div class="flex space-x-4 text-xs font-mono text-gray-400 mb-4 md:mb-0">
                    <div class="text-center">
                        <span class="block text-cyan-400 font-bold uppercase tracking-wider">Hora Actual</span>
                        <span id="current-time-display" class="block text-lg font-light text-white">00:00:00</span>
                    </div>
                    <div class="text-center">
                        <span class="block text-cyan-400 font-bold uppercase tracking-wider">Temps Dedicat</span>
                        <span id="total-time-display" class="block text-lg font-light text-white">00:00:00</span>
                    </div>
                </div>

                <!-- TÍTOL PRINCIPAL (Centre) -->
                <h1 class="text-xl lg:text-3xl font-extrabold tracking-widest text-cyan-400 text-center">MUSIC STUDY PROTOCOL</h1>
                
                <!-- ESTAT DEL PROTOCOL (Dreta) -->
                <p class="text-xs font-mono text-gray-400 mt-4 md:mt-0 uppercase text-center md:text-right">ESTAT: <span id="protocol-status-light" class="text-green-500">PREPARAT</span></p>

            </div>
        </header>
        
        <!-- SECCIÓ CENTRAL: TEMPORITZADOR I INFORMACIÓ DE LA FASE -->
        <main id="app-container" class="flex-grow flex flex-col items-center justify-center p-4 lg:p-0 mb-6 md:mb-12">

            <!-- INFORMACIÓ DE LA FASE ACTUAL AL CENTRE -->
            <div class="text-center mb-10 max-w-xl w-full h-28">
                <!-- Títol de la FASE AGRUPADORA (Grup I, II, o III) -->
                <h3 id="group-titol" class="text-lg md:text-xl font-bold tracking-wider text-gray-500 transition-colors duration-500 mb-1 leading-tight"></h3>
                <!-- Títol de la SUBFASE (e.g. Preparació i So Fonamental) -->
                <h2 id="fase-titol" class="text-2xl md:text-3xl font-bold tracking-wider text-green-400 transition-colors duration-500 mb-2 leading-tight">Preparat per Començar</h2>
                <div id="fase-descripcio" class="text-sm text-gray-400 italic px-4">
                    <span class="block text-base font-medium mb-1">Utilitza el seqüenciador inferior per triar un bloc, i premeu Play per iniciar la rutina.</span>
                    <span class="bpm-text block mt-1 text-xs text-gray-500 font-mono italic">BPM: N/A</span>
                </div>
            </div>
            
            <!-- CERCLE DE PROGRÉS I TEMPS RESTANT -->
            <div class="relative w-64 h-64 md:w-80 md:h-80 flex items-center justify-center">
                
                <!-- SVG del Cercle de Progrés (Dash Array) -->
                <svg id="progress-svg" class="w-full h-full transform -rotate-90" viewBox="0 0 100 100">
                    <!-- Cercle de fons -->
                    <circle class="text-gray-800 stroke-current" stroke-width="6" cx="50" cy="50" r="45" fill="transparent"></circle>
                    <!-- Cercle de progrés (el color canvia amb la fase) -->
                    <circle id="progress-circle" class="progress-ring__circle stroke-current" stroke-width="6" stroke-linecap="round" cx="50" cy="50" r="45" fill="transparent" stroke-dasharray="283" stroke-dashoffset="283"></circle>
                </svg>

                <!-- Temps al Centre del Cercle -->
                <div class="absolute flex flex-col items-center">
                    <p id="time-display" class="text-6xl md:text-7xl font-light text-white">00:00</p>
                    <p id="timer-status" class="text-sm mt-2 text-gray-400 tracking-widest uppercase">INACTIU</p>
                </div>
            </div>

            <!-- CONTROLS DEL TEMPORITZADOR -->
            <div class="flex space-x-8 mt-12">
                
                <!-- Botó per Saltar Enrere -->
                <button id="prev-btn" class="p-4 rounded-full bg-gray-800 hover:bg-gray-700 transition duration-200 text-white disabled:opacity-30 border border-gray-700" title="Saltar a la fase anterior">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7" /></svg>
                </button>
                
                <!-- Botó Principal Play / Pausa -->
                <button id="play-pause-btn" class="p-5 rounded-full bg-green-500 hover:bg-green-600 transition duration-200 text-gray-900 shadow-xl shadow-green-500/50 transform hover:scale-105" title="Inicia/Pausa el temporitzador">
                    <svg id="play-icon" xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>
                    <svg id="pause-icon" xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 hidden" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                </button>
                
                <!-- Botó per Saltar Endavant -->
                <button id="next-btn" class="p-4 rounded-full bg-gray-800 hover:bg-gray-700 transition duration-200 text-white disabled:opacity-30 border border-gray-700" title="Saltar a la següent fase">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7" /></svg>
                </button>
            </div>

        </main>
        
    </div>

    <!-- 4. SEQÜENCIADOR DE FASES (A LA PART INFERIOR) -->
    <aside id="section-navigator" class="w-full bg-gray-900/80 backdrop-blur-sm px-4 py-3 rounded-t-xl border-t border-gray-700/50 flex-shrink-0 mt-auto">
        <h3 class="text-md font-extrabold uppercase tracking-wider text-cyan-400 border-b border-cyan-400/30 pb-2 mb-3 sticky top-0 bg-gray-900/80 z-10">Seqüenciador de Fases</h3>
        <!-- Contenidor de scroll horitzontal -->
        <div id="fase-selector-container" class="flex space-x-4 pb-2">
            <!-- Les targetes de fase es generaran amb JS -->
        </div>
    </aside>

    <script>
        // =======================================================
        // 1. DADES DE LA RUTINA (Basades en l'estructura de l'Excel)
        // =======================================================

        const FASES_ESTUDI = [
            // I. Escalfament i Tècnica (Grup)
            {
                codi: "I",
                titol: "I. Escalfament i Tècnica",
                temps: 20 * 60, // 20 minuts
                descripcio: "Objectiu: Preparar el cos, la ment i l'instrument.",
                bpm: "",
                isGroup: true,
                color: { main: "gray", bg: "bg-gray-950", text: "text-gray-500", shade: 900 }
            },
            // Subfases del Grup I
            {
                codi: "I.1",
                titol: "I.1 Preparació i So Fonamental",
                temps: 5 * 60, // 5 minuts
                descripcio: "Estiraments lleugers i concentració. Toca notes llargues per centrar el teu so, practica exercicis de digitació senzilla per connectar amb l'instrument.",
                bpm: "No s'usa. El focus és la qualitat del so i la respiració.",
                color: { main: "green", bg: "bg-green-950", text: "text-green-400", shade: 700 }
            },
            {
                codi: "I.2",
                titol: "I.2 Tècnica Diària (Escales/Arpegis)",
                temps: 15 * 60, // 15 minuts
                descripcio: "Practica la tècnica amb uniformitat i precisió. ESCALES - ARPEGIS - ACORDS - ESTUDIS",
                bpm: "Inici Lent: 60-80 bpm. Objectiu Mitjà: 100-120 bpm.",
                color: { main: "green", bg: "bg-green-900", text: "text-green-300", shade: 600 }
            },
            // II. Treball del Repertori (Grup)
            {
                codi: "II",
                titol: "II. Treball del Repertori",
                temps: 40 * 60, // 40 minuts
                descripcio: "Objectiu: Abordar les obres i resoldre els problemes tècnics i musicals.",
                bpm: "",
                isGroup: true,
                color: { main: "gray", bg: "bg-gray-950", text: "text-gray-500", shade: 900 }
            },
            // Subfases del Grup II
            {
                codi: "II.1",
                titol: "II.1 Repàs de la peça principal",
                temps: 10 * 60, // 10 minuts
                descripcio: "Toca la peça o fragment que ja domines per guanyar confiança i musicalitat. Recupera el que has estudiat les darreres sessions",
                bpm: "Al tempo indicat a la partitura.",
                color: { main: "cyan", bg: "bg-cyan-950", text: "text-cyan-400", shade: 700 }
            },
            {
                codi: "II.2",
                titol: "II.2 OBJECTIU PRINCIPAL (Passatges Difícils)",
                temps: 25 * 60, // 25 minuts
                descripcio: "Practica lenta i concentrada. Aïlla els errors i treballa-los amb estratègies (tempo lent, per compassos, format obstinat).",
                bpm: "Inici de Treball: 40-60 bpm. Augmenta de manera gradual (5 en 5 bpm) fins al 75% del tempo real.",
                color: { main: "cyan", bg: "bg-cyan-900", text: "text-cyan-300", shade: 600 }
            },
            {
                codi: "II.3",
                titol: "II.3 Simulació",
                temps: 5 * 60, // 5 minuts
                descripcio: "Toca el fragment estudiat sense aturar-te (encara que fallis). Simula una situació d'actuació.",
                bpm: "Al 80% - 100% del tempo real.",
                color: { main: "cyan", bg: "bg-cyan-800", text: "text-cyan-200", shade: 500 }
            },
            // III. Desenvolupament i Planificació (Grup)
            {
                codi: "III",
                titol: "III. Desenvolupament i Planificació",
                temps: 15 * 60, // 15 minuts
                descripcio: "Objectiu: Desenvolupar l'oïda i organitzar.",
                bpm: "",
                isGroup: true,
                color: { main: "gray", bg: "bg-gray-950", text: "text-gray-500", shade: 900 }
            },
            // Subfase del Grup III
            {
                codi: "III.1",
                titol: "III.1 Desenvolupament",
                temps: 15 * 60, // 15 minuts
                descripcio: "Exercicis de lectura a vista senzilla, improvisació sobre un acord/pedal/tonalitat/escala, treure frases/riffs/cançons d'oïda",
                bpm: "No s'usa.",
                color: { main: "fuchsia", bg: "bg-fuchsia-950", text: "text-fuchsia-400", shade: 700 }
            },
        ];

        // Filtrem les fases que realment tenen temps (les subfases) per al temporitzador
        const SUBFASES = FASES_ESTUDI.filter(f => !f.isGroup);
        // Trobem la primera subfase per iniciar
        let currentFaseIndex = FASES_ESTUDI.findIndex(f => !f.isGroup); 


        // =======================================================
        // 2. LÒGICA DEL TEMPORITZADOR PRINCIPAL
        // =======================================================

        let interval;
        let isRunning = false;
        let timeLeft = FASES_ESTUDI[currentFaseIndex].temps;
        const totalCircleLength = 2 * Math.PI * 45; 

        // Elements del DOM del Temporitzador
        const body = document.body;
        const groupTitol = document.getElementById('group-titol');
        const timeDisplay = document.getElementById('time-display');
        const faseTitol = document.getElementById('fase-titol');
        const faseDescripcioDiv = document.getElementById('fase-descripcio');
        const progressCircle = document.getElementById('progress-circle');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const playIcon = document.getElementById('play-icon');
        const pauseIcon = document.getElementById('pause-icon');
        const timerStatus = document.getElementById('timer-status');
        const nextBtn = document.getElementById('next-btn');
        const prevBtn = document.getElementById('prev-btn');
        const protocolStatusLight = document.getElementById('protocol-status-light');
        const onboardingModal = document.getElementById('onboarding-modal');
        const faseSelectorContainer = document.getElementById('fase-selector-container');

        // Mètriques de Temps
        const currentTimeDisplay = document.getElementById('current-time-display');
        const totalTimeDisplay = document.getElementById('total-time-display');
        let totalSecondsDedicated = 0;
        
        function formatTime(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600).toString().padStart(2, '0');
            const minutes = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
            const seconds = (totalSeconds % 60).toString().padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }

        function formatClock(date) {
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const seconds = date.getSeconds().toString().padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }

        function updateClocks() {
            // Rellotge actual
            currentTimeDisplay.textContent = formatClock(new Date());
            
            // Temps total dedicat a la pàgina
            totalTimeDisplay.textContent = formatTime(totalSecondsDedicated);
            totalSecondsDedicated++; // Incrementem cada segon
        }

        function getFaseGroup(faseIndex) {
            // Retorna el títol del grup immediatament anterior (I, II, III)
            for (let i = faseIndex; i >= 0; i--) {
                if (FASES_ESTUDI[i].isGroup) {
                    // Retorna el títol complet del grup (e.g., "I. Escalfament i Tècnica")
                    return FASES_ESTUDI[i].titol;
                }
            }
            return 'PROTOCOL'; // Per si no troba un grup inicial
        }

        function cleanDynamicClasses(element, prefix) {
            const classList = element.classList;
            Array.from(classList).filter(c => c.startsWith(prefix)).forEach(c => classList.remove(c));
        }

        function updateUI() {
            const fase = FASES_ESTUDI[currentFaseIndex];
            const percent = (timeLeft / fase.temps);
            const offset = totalCircleLength * (1 - percent);

            // 1. Actualitza el temps i el cercle de progrés
            timeDisplay.textContent = formatTime(timeLeft).substring(3); // Mostrem només MM:SS
            progressCircle.style.strokeDashoffset = offset;

            // 2. Actualitza els colors i el text de la fase
            const groupTitleFull = getFaseGroup(currentFaseIndex);
            // El títol de grup ha de ser només la part principal (I. Escalfament i Tècnica)
            groupTitol.textContent = groupTitleFull.split('.').slice(0, 2).join('.'); 
            
            // El títol de la subfase ha de ser només el nom (Preparació i So Fonamental)
            faseTitol.textContent = fase.titol.split(' ').slice(1).join(' '); 
            
            // Estructura millorada per la descripció i BPM
            faseDescripcioDiv.innerHTML = `
                <span class="block text-base font-medium mb-1">${fase.descripcio}</span>
                <span class="bpm-text block mt-1 text-xs text-${fase.color.main}-300/80 font-mono italic">BPM: ${fase.bpm || 'N/A'}</span>
            `;

            // 3. Aplicació del tema de color dinàmic
            cleanDynamicClasses(body, 'bg-');
            body.classList.add(fase.color.bg); 
            cleanDynamicClasses(faseTitol, 'text-');
            faseTitol.classList.add(fase.color.text);
            cleanDynamicClasses(progressCircle, 'stroke-');
            progressCircle.classList.add(`stroke-${fase.color.main}-400`);
            cleanDynamicClasses(playPauseBtn, 'bg-');
            cleanDynamicClasses(playPauseBtn, 'shadow-');
            playPauseBtn.classList.add(`bg-${fase.color.main}-500`, `hover:bg-${fase.color.main}-600`, `shadow-xl`, `shadow-${fase.color.main}-500/50`, 'transform', 'hover:scale-105');
            
            // 4. Estat del Protocol
            if (isRunning) {
                timerStatus.textContent = 'FLUX ACTIU';
                protocolStatusLight.textContent = 'ACTIU';
                cleanDynamicClasses(protocolStatusLight, 'text-');
                protocolStatusLight.classList.add(`text-${fase.color.main}-400`, 'animate-pulse');
            } else {
                timerStatus.textContent = 'PAUSA';
                protocolStatusLight.textContent = 'PAUSA';
                cleanDynamicClasses(protocolStatusLight, 'text-');
                protocolStatusLight.classList.add('text-yellow-400', 'animate-none');
            }
            
            // Troba els índexs de les subfases disponibles
            const subfasesIndexes = FASES_ESTUDI
                .map((f, i) => f.isGroup ? -1 : i)
                .filter(i => i !== -1);
            
            const currentSubfaseIndexInList = subfasesIndexes.indexOf(currentFaseIndex);

            prevBtn.disabled = currentSubfaseIndexInList === 0;
            nextBtn.disabled = currentSubfaseIndexInList === subfasesIndexes.length - 1; 

            // Actualitza l'estat del selector de fases
            updateFaseSelector();

            if (timeLeft === 0 && isRunning) {
                playSoundAlert();
            }
        }

        function changeFase(index) {
            const fase = FASES_ESTUDI[index];
            if (!fase || fase.isGroup) return; // No permet canviar a un grup

            currentFaseIndex = index;
            timeLeft = FASES_ESTUDI[currentFaseIndex].temps;
            pauseTimer();
            updateUI();
            scrollToFase(index);
        }
        
        function getNextSubFaseIndex(currentIndex) {
            for (let i = currentIndex + 1; i < FASES_ESTUDI.length; i++) {
                if (!FASES_ESTUDI[i].isGroup) {
                    return i;
                }
            }
            return -1; // Final
        }

        function getPrevSubFaseIndex(currentIndex) {
            for (let i = currentIndex - 1; i >= 0; i--) {
                if (!FASES_ESTUDI[i].isGroup) {
                    return i;
                }
            }
            return -1; // Inici
        }

        function startTimer() {
            if (isRunning) return;
            isRunning = true;
            playIcon.classList.add('hidden');
            pauseIcon.classList.remove('hidden');
            updateUI(); 

            interval = setInterval(() => {
                if (timeLeft > 0) {
                    timeLeft--;
                    updateUI();
                } else {
                    clearInterval(interval);
                    playSoundAlert();
                    isRunning = false; 
                    
                    const nextIndex = getNextSubFaseIndex(currentFaseIndex);

                    if (nextIndex !== -1) {
                        changeFase(nextIndex);
                        startTimer(); 
                    } else {
                        // Rutina acabada
                        timerStatus.textContent = 'FINALITZAT';
                        protocolStatusLight.textContent = 'FINALITZAT';
                        cleanDynamicClasses(protocolStatusLight, 'text-');
                        protocolStatusLight.classList.add('text-red-500', 'animate-none');
                        groupTitol.textContent = 'FLUX COMPLETAT';
                        faseTitol.textContent = 'OBJECTIU ASSOLIT';
                        faseDescripcioDiv.innerHTML = '<span class="block">Felicitats! Protocol completat.</span>';
                        playIcon.classList.remove('hidden');
                        pauseIcon.classList.add('hidden');
                    }
                }
            }, 1000);
        }

        function pauseTimer() {
            clearInterval(interval);
            isRunning = false;
            updateUI(); 
        }

        function togglePlayPause() {
            if (isRunning) {
                pauseTimer();
            } else {
                if (timeLeft === 0 && getNextSubFaseIndex(currentFaseIndex) === -1) {
                    // Si ha acabat i tornem a prémer play, comencem per la primera subfase
                    currentFaseIndex = FASES_ESTUDI.findIndex(f => !f.isGroup);
                    timeLeft = FASES_ESTUDI[currentFaseIndex].temps;
                }
                startTimer();
            }
        }
        
        playPauseBtn.addEventListener('click', togglePlayPause);
        nextBtn.addEventListener('click', () => {
            const nextIndex = getNextSubFaseIndex(currentFaseIndex);
            if (nextIndex !== -1) {
                changeFase(nextIndex);
            }
        });
        prevBtn.addEventListener('click', () => {
             const prevIndex = getPrevSubFaseIndex(currentFaseIndex);
             if (prevIndex !== -1) {
                changeFase(prevIndex);
            }
        });

        function playSoundAlert() {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                
                oscillator.type = 'triangle';
                oscillator.frequency.setValueAtTime(880, audioCtx.currentTime); 
                gainNode.gain.setValueAtTime(0.6, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.5); 
                oscillator.start();
                
                oscillator.stop(audioCtx.currentTime + 0.5);
            } catch (error) {
                console.error("Error al reproduir so d'alerta:", error);
            }
        }
        
        // =======================================================
        // 3. SEQÜENCIADOR DE FASES (Inferior amb Scroll)
        // =======================================================

        /**
         * Genera les targetes de navegació inferior.
         */
        function buildFaseSelector() {
            faseSelectorContainer.innerHTML = ''; 
            FASES_ESTUDI.forEach((fase, index) => {
                const wrapper = document.createElement('div');
                wrapper.className = `fase-btn-wrapper flex-shrink-0`;

                const btn = document.createElement('button');
                const timeMin = Math.floor(fase.temps / 60);
                
                const isGroup = fase.isGroup;
                // Agafem només el codi de la fase principal (I, II, III)
                const mainGroupCode = fase.codi.split('.')[0]; 
                
                let contentHTML = '';
                let buttonClasses = 'w-full transition duration-150 text-left fase-btn'; // Afegim classe per facilitar l'update
                
                if (isGroup) {
                    // Estil per a FASES AGRUPADORES
                    contentHTML = `
                        <div class="flex flex-col items-start p-3 rounded-lg border border-gray-600/50 transition duration-150 text-left w-full h-full justify-between bg-gray-900/50 hover:bg-gray-700/50 border-dashed">
                            <span class="text-xs font-mono font-bold uppercase tracking-widest text-gray-500">${mainGroupCode} - ${timeMin} min TOTAL</span>
                            <span class="text-lg font-extrabold text-white mt-1">${fase.titol.split('.').slice(1).join('.').trim()}</span>
                        </div>
                    `;
                    // Els grups no són clicables (ja que el temporitzador no els executa)
                    btn.disabled = true; 
                    buttonClasses += ' cursor-default opacity-70';
                } else {
                    // Estil per a SUBFASES (Clicables)
                    contentHTML = `
                        <div class="flex flex-col items-start p-3 rounded-lg border border-gray-700/50 transition duration-150 text-left w-full h-full justify-between bg-gray-900/50 hover:bg-gray-800/80">
                            <span class="text-xs font-mono font-bold uppercase tracking-widest text-gray-500">${mainGroupCode} - ${timeMin} min</span>
                            <span class="text-sm font-semibold text-gray-200 mt-1">${fase.titol.split(' ').slice(1).join(' ')}</span>
                        </div>
                    `;
                    btn.addEventListener('click', () => {
                        changeFase(index);
                    });
                }


                btn.innerHTML = contentHTML;
                btn.className = buttonClasses;
                btn.setAttribute('data-index', index);
                
                wrapper.appendChild(btn);
                faseSelectorContainer.appendChild(wrapper);
            });
        }
        
        /**
         * Actualitza les classes de color del selector per marcar la fase activa.
         */
        function updateFaseSelector() {
            document.querySelectorAll('.fase-btn').forEach((btn, index) => {
                const fase = FASES_ESTUDI[index];
                const card = btn.querySelector('div');
                if (!card) return;

                const isGroup = fase.isGroup;
                const titleEl = card.querySelector('span:nth-child(2)');
                const groupTimeEl = card.querySelector('span:nth-child(1)');
                
                // Neteja les classes dinàmiques (bord, bg, shadow, text)
                cleanDynamicClasses(card, 'bg-');
                cleanDynamicClasses(card, 'shadow-');
                cleanDynamicClasses(card, 'border-');
                cleanDynamicClasses(titleEl, 'text-');
                cleanDynamicClasses(groupTimeEl, 'text-');

                // Neteja classes de grup específiques
                card.classList.remove('border-dashed', 'opacity-80', 'border-gray-600/50');
                
                if (index === currentFaseIndex) {
                    // Estil per a la fase ACTIVA (Neó) - Només subfases
                    if (!isGroup) {
                        card.classList.add(`bg-${fase.color.main}-900/80`, `shadow-lg`, `shadow-${fase.color.main}-500/50`, `border-${fase.color.main}-400`);
                        titleEl.classList.add(`text-${fase.color.main}-200`);
                        groupTimeEl.classList.add(`text-${fase.color.main}-300`);
                    } else {
                         // Aquesta lògica no s'hauria d'activar si el canvi de fase només permet subfases
                        card.classList.add('bg-gray-800/50', 'border-gray-700/50', 'border-dashed');
                        titleEl.classList.add('text-white');
                        groupTimeEl.classList.add('text-gray-500');
                    }
                } else {
                    // Estil per a les fases INACTIVES
                    if (!isGroup) {
                        card.classList.add('bg-gray-800/50', 'border-gray-700/50', 'hover:bg-gray-700/70');
                        titleEl.classList.add('text-gray-200');
                        groupTimeEl.classList.add('text-gray-500');
                    } else {
                        // Estil per a separadors de grup inactius
                        card.classList.add('bg-gray-900/50', 'border-gray-600/50', 'border-dashed', 'opacity-80');
                        titleEl.classList.add('text-white');
                        groupTimeEl.classList.add('text-gray-500');
                    }
                }
            });
        }

        /**
         * Desplaça el scroll del contenidor de fases a la fase actual.
         * @param {number} index - Índex de la fase activa.
         */
        function scrollToFase(index) {
            const element = faseSelectorContainer.querySelector(`[data-index="${index}"]`);
            if (element) {
                // Utilitzem l'element wrapper per garantir el scroll-snap
                const wrapper = element.parentElement; 
                if (wrapper) {
                    faseSelectorContainer.scrollTo({
                        left: wrapper.offsetLeft - (faseSelectorContainer.clientWidth / 2) + (wrapper.clientWidth / 2),
                        behavior: 'smooth'
                    });
                }
            }
        }

        // =======================================================
        // 4. METRÒNOM (Funcions prèviament definides)
        // =======================================================

        let audioCtx;
        let metronomeInterval; 
        let metronomeIsRunning = false;
        let currentBPM = 100; 
        const MIN_BPM = 40;
        const MAX_BPM = 150;
        let timeSignature = 4;
        let beatCount = 0; 
        let currentVolume = 0.5; 
        let isCollapsed = (window.innerWidth < 1024); 
        
        // Elements del DOM del Metrònom
        const metronomeArea = document.getElementById('metronome-area');
        const metronomeToggleIcon = document.getElementById('metronome-toggle-icon');
        const metronomeControlsExpanded = document.getElementById('metronome-controls-expanded');
        const metronomeMinimizedView = document.getElementById('metronome-minimized-view');
        const metronomToggleBtn = document.getElementById('metronom-toggle'); 
        const metronomPlayPauseMin = document.getElementById('metronom-play-pause-min');
        const minPlayIcon = document.getElementById('min-play-icon');
        const minStopIcon = document.getElementById('min-stop-icon');
        const minimizedBPM = document.getElementById('minimized-bpm');
        const metronomeState = document.getElementById('metronome-state');
        const metronomVisual = document.getElementById('metronom-visual');
        const bpmInput = document.getElementById('bpm-input');
        const bpmSlider = document.getElementById('bpm-slider');
        const volumeSlider = document.getElementById('volume-slider');
        const volumeDisplay = document.getElementById('volume-display');
        const metronomPlayIcon = document.getElementById('metronom-play-icon');
        const metronomStopIcon = document.getElementById('metronom-stop-icon');
        
        
        function createClick(time, isAccent) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            const frequency = isAccent ? 1000 : 800; 
            const duration = 0.05; 
            
            osc.type = 'square';
            osc.frequency.setValueAtTime(frequency, time); 
            
            gain.gain.setValueAtTime(currentVolume, time);
            gain.gain.exponentialRampToValueAtTime(0.001, time + duration); 

            osc.start(time);
            osc.stop(time + duration);
        }

        function metronomeTick() {
            if (!metronomeIsRunning) return;
            
            beatCount = (beatCount % timeSignature) + 1;
            const isAccent = beatCount === 1;

            try {
                if (audioCtx.state === 'suspended') { audioCtx.resume(); }
                const now = audioCtx.currentTime;
                createClick(now, isAccent);
            } catch (error) {
                console.warn("Error en crear el click d'àudio.", error);
            }
            
            if (!isCollapsed) {
                metronomVisual.classList.remove('bg-gray-700', 'bg-cyan-500/50');
                if (isAccent) {
                    metronomVisual.classList.add('bg-[#00ffff]', 'shadow-md', 'shadow-[#00ffff]/80', 'animate-pulse'); 
                } else {
                    metronomVisual.classList.add('bg-cyan-500/50'); 
                }
                setTimeout(() => {
                    metronomVisual.classList.remove('bg-[#00ffff]', 'bg-cyan-500/50', 'shadow-md', 'shadow-[#00ffff]/80', 'animate-pulse');
                    metronomVisual.classList.add('bg-gray-700');
                }, 50);
            }
        }

        function updateMetronomeInterval() {
             if (metronomeIsRunning) {
                clearInterval(metronomeInterval);
                const secondsPerBeat = 60 / currentBPM;
                const delay = secondsPerBeat * 1000;
                metronomeInterval = setInterval(metronomeTick, delay); 
            }
        }

        function startMetronome() {
            if (metronomeIsRunning) return;
            
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            metronomeIsRunning = true;
            beatCount = 0; 
            
            updateMetronomeInterval();
            
            metronomeState.textContent = 'ACTIU';
            metronomeState.classList.add('text-green-500', 'animate-pulse');
            metronomeState.classList.remove('text-gray-500', 'text-yellow-500');

            metronomPlayIcon.classList.add('hidden');
            metronomStopIcon.classList.remove('hidden');
            metronomToggleBtn.classList.add('bg-red-500', 'shadow-red-500/50');
            metronomToggleBtn.classList.remove('bg-[#00ffff]', 'shadow-[#00ffff]/30');
            
            minPlayIcon.classList.add('hidden');
            minStopIcon.classList.remove('hidden');
            metronomPlayPauseMin.classList.add('bg-red-500');
            metronomPlayPauseMin.classList.remove('bg-cyan-600');
        }

        function stopMetronome() {
            if (!metronomeIsRunning) return;
            clearInterval(metronomeInterval);
            metronomeIsRunning = false;
            
            metronomeState.textContent = 'PAUSA';
            metronomeState.classList.remove('text-green-500', 'animate-pulse');
            metronomeState.classList.add('text-yellow-500');

            metronomPlayIcon.classList.remove('hidden');
            metronomStopIcon.classList.add('hidden');
            metronomVisual.classList.remove('bg-[#00ffff]', 'bg-cyan-500/50', 'shadow-md', 'shadow-[#00ffff]/80', 'animate-pulse');
            metronomVisual.classList.add('bg-gray-700');
            metronomToggleBtn.classList.remove('bg-red-500', 'shadow-red-500/50');
            metronomToggleBtn.classList.add('bg-[#00ffff]', 'shadow-[#00ffff]/30');

            minPlayIcon.classList.remove('hidden');
            minStopIcon.classList.add('hidden');
            metronomPlayPauseMin.classList.remove('bg-red-500');
            metronomPlayPauseMin.classList.add('bg-cyan-600');
        }
        
        function toggleMetronomeCollapse() {
            isCollapsed = !isCollapsed;
            
            if (isCollapsed) {
                metronomeArea.classList.add('metronom-minimized');
                metronomeControlsExpanded.classList.add('hidden');
                metronomeMinimizedView.classList.remove('hidden');
                metronomeToggleIcon.classList.add('rotate-180');
            } else {
                metronomeArea.classList.remove('metronom-minimized');
                metronomeControlsExpanded.classList.remove('hidden');
                metronomeMinimizedView.classList.add('hidden');
                metronomeToggleIcon.classList.remove('rotate-180');
            }
        }
        
        function updateBPM(newBPM) {
            newBPM = parseInt(newBPM);
            currentBPM = Math.max(MIN_BPM, Math.min(MAX_BPM, newBPM)); 

            bpmInput.value = currentBPM;
            bpmSlider.value = currentBPM;
            minimizedBPM.textContent = `${currentBPM} BPM`;
            
            if (metronomeIsRunning) {
                updateMetronomeInterval();
            }
        }
        
        function updateVolume(newVolumePercent) {
            currentVolume = parseFloat(newVolumePercent) / 100;
            volumeDisplay.textContent = `${newVolumePercent}%`;
        }

        metronomToggleBtn.addEventListener('click', (event) => { 
            event.stopPropagation();
            metronomeIsRunning ? stopMetronome() : startMetronome();
        });
        
        metronomPlayPauseMin.addEventListener('click', (event) => {
            event.stopPropagation();
            metronomeIsRunning ? stopMetronome() : startMetronome();
        });

        bpmInput.addEventListener('input', (e) => updateBPM(e.target.value));
        bpmSlider.addEventListener('input', (e) => updateBPM(e.target.value));
        volumeSlider.addEventListener('input', (e) => updateVolume(e.target.value));

        // Aplica l'estat inicial col·lapsat si és necessari
        if (isCollapsed) {
            metronomeArea.classList.add('metronom-minimized');
            metronomeControlsExpanded.classList.add('hidden');
            metronomeMinimizedView.classList.remove('hidden');
            metronomeToggleIcon.classList.add('rotate-180');
        } else {
            metronomeMinimizedView.classList.add('hidden');
        }


        // =======================================================
        // 5. LÒGICA DEL MODAL D'INICI i INICIALITZACIÓ
        // =======================================================

        function closeOnboardingModal() {
            onboardingModal.classList.add('opacity-0');
            setTimeout(() => {
                onboardingModal.classList.add('hidden');
                document.body.style.overflow = 'auto'; 
            }, 300);
        }
        
        window.onload = function() {
            // Inicialització del rellotge i comptador dedicat
            setInterval(updateClocks, 1000); 

            // Inicialització del temporitzador
            progressCircle.style.strokeDasharray = totalCircleLength;
            progressCircle.style.strokeDashoffset = totalCircleLength; 
            buildFaseSelector();
            updateUI(); 
            
            // La primera fase ha de ser sempre una subfase (la que té temps)
            const firstSubfase = FASES_ESTUDI[currentFaseIndex];
            timeDisplay.textContent = formatTime(firstSubfase.temps).substring(3);
            
            // Inicialització del metrònom
            updateBPM(currentBPM);
            updateVolume(currentVolume * 100);
            
            // Mostrar el modal
            document.body.style.overflow = 'hidden'; 
            onboardingModal.classList.remove('hidden', 'opacity-0');
        };

    </script>
</body>
</html>
